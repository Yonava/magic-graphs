import{ay as Ne,az as xe,aA as Ae,U as we,z as V,B as J,aB as $,aC as ge,aD as Ce,aa as re,H as U,g as C,y as he,aE as Ie,a8 as Z,aF as ve,aG as Me,an as De,ao as Be,aH as ke,aI as pe,u as me,A as ee,aq as Re,ar as Oe,aJ as Fe,aK as Le,aL as _e,aM as Ge,aN as Pe,aO as Ue,e as We,o as He,N as qe}from"./index-_A0fE95w.js";import{c as be,a as Ke,u as ze,l as ye,b as Ve,g as Ee,r as ae,s as j,_ as Je}from"./ResponsiveCanvas.vue_vue_type_script_setup_true_lang-BiDsemoy.js";const te={light:Ne,dark:xe,girl:Ae},Ye=(s,o)=>{const e=we();V(e,()=>{const u=s.theme.value;e.value?Object.assign(u,{...te.dark,...o}):Object.assign(u,{...te.light,...o})},{immediate:!0})},je=(s,o)=>{const e=o("nodeColor",s),u=o("nodeBorderColor",s),t=o("nodeSize",s),n=o("nodeBorderWidth",s),y=o("nodeText",s),d=o("nodeTextSize",s),b=o("nodeTextColor",s),g=o("nodeShape",s),N=be({at:{x:s.x,y:s.y},radius:t,color:e,stroke:{color:u,width:n},textArea:{text:{content:y,fontSize:d,fontWeight:"bold",color:b},color:J.TRANSPARENT}}),f=Ke({at:{x:s.x-t,y:s.y-t},size:t*2,color:e,stroke:{color:u,width:n},textArea:{text:{content:y,fontSize:d,fontWeight:"bold",color:b},color:J.TRANSPARENT}});return{shape:g==="circle"?N:f,id:s.id,graphType:"node"}},Ze=1.618,ue=2,Xe=(s,o)=>{const{displayEdgeLabels:e,isGraphDirected:u}=o.settings.value,[t,n]=$(s.id,o),d=ge(t.id,n.id,o).length>1,b=n===t,g=o.getTheme("nodeBorderWidth",t),N=o.getTheme("nodeBorderWidth",n),f=o.getTheme("nodeSize",t),E=o.getTheme("nodeSize",n),m=Math.atan2(n.y-t.y,n.x-t.x),i=N/2+ue,c={x:(E+i)*Math.cos(m),y:(E+i)*Math.sin(m)},p={x:t.x,y:t.y},x={x:n.x-(u?c.x:0),y:n.y-(u?c.y:0)},h=o.getTheme("edgeWidth",s),a=h*1.2;d&&(p.x+=Math.cos(m+Math.PI/2)*a,p.y+=Math.sin(m+Math.PI/2)*a,x.x+=Math.cos(m+Math.PI/2)*a,x.y+=Math.sin(m+Math.PI/2)*a);const v=Ce(p,o.edges.value.filter(R=>(R.from===t.id||R.to===n.id)&&R.from!==R.to).map(R=>{const[W,G]=$(R.id,o);return t.id===W.id?{x:G.x,y:G.y}:{x:W.x,y:W.y}}).filter((R,W,G)=>W===G.findIndex(Y=>Y.x===R.x&&Y.y===R.y))),r=o.getTheme("edgeColor",s),l=o.getTheme("edgeTextColor",s),T=o.getTheme("graphBgColor"),w=o.getTheme("edgeText",s),B=o.getTheme("edgeTextSize",s),D=o.getTheme("edgeTextFontWeight",s),I=e?{color:T,activeColor:T,text:{content:w,color:l,fontSize:B,fontWeight:D}}:void 0,M=(f+g)*Ze,O=M-(f+g/2)-ue;if(b)return{shape:ze({spacing:h*1.2,at:{x:t.x,y:t.y},upDistance:M,downDistance:O,rotation:v,lineWidth:h,color:r,textArea:I}),id:s.id,graphType:"edge"};const L=f+g/2+E+N/2,_=(t.x-n.x)**2+(t.y-n.y)**2;if(L**2>_)return;if(!u)return{shape:ye({start:p,end:x,width:h,color:r,textArea:I}),id:s.id,graphType:"edge"};const P=f>=50?.9:f>=25?1:1.3;return{shape:Ve({start:p,end:x,width:h,textOffsetFromCenter:f**P,color:r,textArea:I}),id:s.id,graphType:"edge"}},Qe=()=>({primaryColor:[],secondaryColor:[],tertiaryColor:[],primaryTextColor:[],secondaryTextColor:[],tertiaryTextColor:[],nodeSize:[],nodeBorderWidth:[],nodeColor:[],nodeBorderColor:[],nodeFocusColor:[],nodeFocusBorderColor:[],nodeText:[],nodeFocusTextColor:[],nodeTextSize:[],nodeTextColor:[],nodeShape:[],edgeColor:[],edgeWidth:[],edgeText:[],edgeTextSize:[],edgeTextColor:[],edgeFocusTextColor:[],edgeTextFontWeight:[],edgeFocusColor:[],graphBgColor:[],graphBgPatternColor:[],nodeAnchorRadius:[],nodeAnchorColor:[],nodeAnchorColorWhenParentFocused:[],linkPreviewColor:[],linkPreviewWidth:[],marqueeSelectionBoxColor:[],marqueeSelectionBoxBorderColor:[],marqueeEncapsulatedNodeBoxColor:[],marqueeEncapsulatedNodeBoxBorderColor:[]}),$e=s=>Object.prototype.toString.call(s)==="[object Object]",oe=(s,o)=>{const e={};if(!s)return o;if(!o)return null;const u=Object.keys(s),t=Object.keys(o);for(const n of t)u.includes(n)||(e[n]=o[n]);for(const n of u){if($e(s[n])){const y=oe(s[n],o[n]);y&&(e[n]=y);continue}if(Array.isArray(s[n])){JSON.stringify(s[n])!==JSON.stringify(o[n])&&(e[n]=o[n]);continue}else s[n]!==o[n]&&(e[n]=o[n])}return Object.keys(e).length?e:null},K=s=>{const o={...s};for(const e in o)typeof o[e]=="object"&&(o[e]=K(o[e]));return o},et=s=>({subscribe:(o,e)=>s[o].add(e),unsubscribe:(o,e)=>s[o].delete(e),emit:(o,...e)=>{for(const u of s[o])u(...e)}}),tt=()=>({onStructureChange:new Set,onNodeAdded:new Set,onBulkNodeAdded:new Set,onNodeRemoved:new Set,onBulkNodeRemoved:new Set,onNodeMoved:new Set,onBulkNodeMoved:new Set,onEdgeAdded:new Set,onBulkEdgeAdded:new Set,onEdgeRemoved:new Set,onBulkEdgeRemoved:new Set,onEdgeLabelEdited:new Set,onRepaint:new Set,onNodeHoverChange:new Set,onGraphReset:new Set,onClick:new Set,onMouseDown:new Set,onMouseUp:new Set,onMouseMove:new Set,onDblClick:new Set,onContextMenu:new Set,onKeyDown:new Set,onKeyUp:new Set,onThemeChange:new Set,onSettingsChange:new Set,onUndo:new Set,onRedo:new Set,onFocusChange:new Set,onNodeDragStart:new Set,onNodeDrop:new Set,onNodeAnchorDragStart:new Set,onNodeAnchorDrop:new Set,onGroupDragStart:new Set,onGroupDrop:new Set}),ie=s=>s==null,ot=s=>{const o=s.trim().split("/").filter(Boolean);if(o.length!==2)return!1;const[e,u]=o.map(Number);return!(ie(e)||ie(u))},nt=s=>{if(!ot(s))return;const o=s.split("/"),[e,u]=o.map(Number);return e/u},st={displayEdgeLabels:!0,edgeLabelsEditable:!0,edgeInputToLabel:s=>{var u;const o=s.trim();if(!o)return;const e=(u=nt(o))==null?void 0:u.toFixed(2);return e==="Infinity"?"∞":e==="-Infinity"?"-∞":e===void 0&&isNaN(Number(o))?void 0:e??o},newNodeLabelGetter:null,isGraphDirected:!0},rt={focusable:!0,focusBlacklist:[]},at={draggable:!0},ut={nodeAnchors:!0},it={marquee:!0,marqueeSelectableGraphTypes:["node","edge"]},ct={userEditable:!0,userAddedEdgeLabel:"1",userAddedEdgeRuleNoSelfLoops:!1,userAddedEdgeRuleOneEdgePerPath:!1},dt={persistent:!0,persistentStorageKey:"graph",persistentBlacklist:new Set},lt={},ft={...st,...rt,...at,...ut,...it,...ct,...dt,...lt},gt=(s,o)=>(e,...u)=>{const t=o[e].findLast(y=>{const d=y.value;return re(d,...u)!==void 0}),n=(t==null?void 0:t.value)??s.value[e];if(!n)throw new Error(`Theme property "${e}" not found`);return re(n,...u)},ht=(s,o)=>{const e=U(()=>{const t=new Map;for(const n of s.value)t.set(n.id,n);return t}),u=U(()=>{const t=new Map;for(const n of o.value)t.set(n.id,n);return t});return{nodeIdToNodeMap:e,edgeIdToEdgeMap:u}},vt=({canvas:s,emit:o})=>{const e=C([]),u=[],t=()=>{var E,m,i,c;if(!s.value)return;const d=s.value.getContext("2d");if(!d)return;d.clearRect(0,0,s.value.width,s.value.height);const b=u.reduce((p,x)=>x(p),[]);e.value=[...b.sort((p,x)=>p.priority-x.priority)];const g=e.value.findLastIndex(p=>p.graphType==="edge"),N=e.value.slice(0,g+1),f=e.value.slice(g+1);for(const p of N)p.shape.drawShape(d);for(const p of N)(m=(E=p.shape).drawTextAreaMatte)==null||m.call(E,d);for(const p of N)(c=(i=p.shape).drawText)==null||c.call(i,d);for(const p of f)p.shape.draw(d);o("onRepaint",d,"loop")},n=setInterval(t,1e3/60);return he(()=>{clearInterval(n)}),setTimeout(t,1e3),{aggregator:e,updateAggregator:u,getSchemaItemsByCoordinates:d=>e.value.sort((b,g)=>b.priority-g.priority).filter(b=>{var g,N;return b.shape.shapeHitbox(d)||((N=(g=b.shape).textHitbox)==null?void 0:N.call(g,d))})}},pt={broadcast:!0,focus:!0,history:!0},mt={broadcast:!0,focus:!1,history:!0},ce={broadcast:!0,history:!0},Q={broadcast:!0,focus:!1,history:!0},de={broadcast:!0,history:!0},bt={broadcast:!0},yt={label:""},Et=({nodes:s,edges:o,nodeMap:e,edgeMap:u,emit:t,settings:n})=>{const y=h=>e.value.get(h),d=h=>u.value.get(h),b=(h,a={})=>{if(h!=null&&h.id&&y(h.id)){console.warn("prevented adding a node with an existing id, this shouldn't happen");return}const v={...pt,...a},r=n.value.newNodeLabelGetter??Ie({nodes:s}),l={id:h.id??Z(),label:h.label??r(),x:h.x??0,y:h.y??0};return s.value.push(l),t("onNodeAdded",l,v),t("onStructureChange",s.value,o.value),l},g=(h,a={})=>{if(h.length===0)return;const v={...mt,...a},r=[];for(const l of h){const T=b(l,{focus:!1,broadcast:!1,history:!1});T&&r.push(T)}r.length!==0&&t("onBulkNodeAdded",r,v)},N=(h,a={})=>{const v={...Q,...a},{isGraphDirected:r}=n.value,[l,T]=[y(h.from),y(h.to)];if(!l||!T)return;if(r){if(o.value.find(D=>D.from===h.from&&D.to===h.to))return}else if(o.value.find(D=>D.from===h.from&&D.to===h.to||D.from===h.to&&D.to===h.from))return;const w={...yt,id:Z(),...h};return o.value.push(w),t("onEdgeAdded",w,v),t("onStructureChange",s.value,o.value),w},f=(h,a={})=>{if(h.length===0)return;const v={...Q,...a},r=[];for(const l of h){const T=N(l,{broadcast:!1,history:!1});T&&r.push(T)}r.length!==0&&t("onBulkEdgeAdded",r,v)},E=(h,a,v={})=>{const r=y(h);if(!r)return;const l={...bt,...v};r.x=a.x,r.y=a.y,t("onNodeMoved",r,l)},m=(h,a,v={})=>{const r={...Q,...v},l=d(h);if(!l)return;const T=l.label;l.label=a,t("onEdgeLabelEdited",l,T,r),t("onStructureChange",s.value,o.value)},i=(h,a={})=>{const v=y(h);if(!v)return;const r={...ce,...a},T=ve(v.id,{edges:o,getEdge:d,settings:n}).map(w=>p(w.id,{broadcast:!1,history:!1})).filter(Boolean);return s.value=s.value.filter(w=>w.id!==v.id),t("onNodeRemoved",v,T,r),t("onStructureChange",s.value,o.value),[v,T]},c=(h,a={})=>{if(h.length===0)return;const v={...ce,...a},r=[],l=[];for(const T of h){const w=i(T,{broadcast:!1,history:!1});if(!w)continue;const[B,D]=w;r.push(B),l.push(...D)}r.length!==0&&t("onBulkNodeRemoved",r,l,v)},p=(h,a={})=>{const v=d(h);if(!v)return;const r={...de,...a};return o.value=o.value.filter(l=>l.id!==v.id),t("onEdgeRemoved",v,r),t("onStructureChange",s.value,o.value),v};return{getNode:y,getEdge:d,addNode:b,addEdge:N,moveNode:E,editEdgeLabel:m,removeNode:i,removeEdge:p,bulkAddNode:g,bulkRemoveNode:c,bulkAddEdge:f,bulkRemoveEdge:(h,a={})=>{if(h.length===0)return;const v={...de,...a},r=[];for(const l of h){const T=p(l,{broadcast:!1,history:!1});T&&r.push(T)}if(r.length!==0)return t("onBulkEdgeRemoved",r,v),r}}},Tt=({subscribe:s,canvas:o,graphAtMousePosition:e})=>{const u=C(!1),t=C(!1),n=C({node:"grab",edge:"pointer","node-anchor":"grab","encapsulated-node-box":"move"}),y=C(),d=U(()=>!!y.value),b=E=>{y.value=E},g=()=>{y.value=void 0},N=E=>{var i;if(!E)return"default";if(d.value)return((i=y.value)==null?void 0:i.call(y,E))??!1?"pointer":"default";const m=n.value[E.graphType]??"default";return m==="grab"&&u.value?"grabbing":m},f=({items:E})=>{if(!o.value||t.value)return;const m=E.at(-1);o.value.style.cursor=N(m)};return s("onMouseDown",E=>{u.value=!0,f(E)}),s("onMouseUp",E=>{u.value=!1,f(E)}),s("onMouseMove",f),V(n,()=>{f({items:e.value.items})},{deep:!0}),{graphToCursorMap:n,activateCursorSelectMode:b,deactivateCursorSelectMode:g,graphCursorDisabled:t}},St=(s,o={})=>{const e=C({...te.light,...o.theme}),u=Qe(),t=gt(e,u),n=C({...ft,...o.settings}),y=tt(),{subscribe:d,unsubscribe:b,emit:g}=et(y),N=C(!0);Me(s,()=>{N.value=!1}),d("onMouseDown",()=>{N.value=!0});const f=C([]),E=C([]),m=C({coords:{x:0,y:0},items:[]}),i=Tt({canvas:s,subscribe:d,graphAtMousePosition:m}),c=A=>{const k=Ee(s),F=ke(A,k);m.value={coords:F,items:r(F)}},p=A=>({...m.value,event:A}),x={click:A=>g("onClick",p(A)),mousemove:A=>g("onMouseMove",p(A)),mousedown:A=>g("onMouseDown",p(A)),mouseup:A=>g("onMouseUp",p(A)),dblclick:A=>g("onDblClick",p(A)),contextmenu:A=>g("onContextMenu",p(A))},h={keydown:A=>g("onKeyDown",A),keyup:A=>g("onKeyUp",A)},{aggregator:a,updateAggregator:v,getSchemaItemsByCoordinates:r}=vt({canvas:s,emit:g}),l=A=>{const k={edges:E,getNode:B,getEdge:D,getTheme:t,settings:n},F=E.value.map(H=>Xe(H,k)).filter(Boolean).map((H,X)=>({...H,priority:X*10})),Se=f.value.map(H=>je(H,t)).filter(Boolean).map((H,X)=>({...H,priority:X*10+1e3}));return A.push(...F),A.push(...Se),A};v.push(l),De(()=>{if(!s.value)throw new Error("canvas element not found");s.value.addEventListener("mousemove",c);for(const[A,k]of Object.entries(x))s.value.addEventListener(A,k);for(const[A,k]of Object.entries(h))document.addEventListener(A,k)}),Be(()=>{if(!s.value)throw new Error("Canvas element not found");s.value.removeEventListener("mousemove",c);for(const[A,k]of Object.entries(x))s.value.removeEventListener(A,k);for(const[A,k]of Object.entries(h))document.removeEventListener(A,k)});const{nodeIdToNodeMap:T,edgeIdToEdgeMap:w}=ht(f,E),{getNode:B,getEdge:D,addNode:S,addEdge:I,moveNode:M,editEdgeLabel:O,removeNode:L,removeEdge:_,bulkAddNode:q,bulkRemoveNode:P,bulkAddEdge:z,bulkRemoveEdge:R}=Et({nodes:f,edges:E,nodeMap:T,edgeMap:w,emit:g,settings:n}),W=(A,k)=>{const F=r({x:A,y:k}).pop();if(F&&F.graphType==="node")return B(F.id)};let G;d("onMouseMove",({items:A})=>{const k=A.at(-1);if(!k||k.graphType!=="node")return;const F=B(k.id);F!==G&&(g("onNodeHoverChange",F,G),G=F)});const Y=A=>(G&&pe(G.id,A),A);v.push(Y);const Te=()=>{f.value=[],E.value=[],g("onGraphReset")};d("onGraphReset",()=>g("onStructureChange",f.value,E.value));const ne=C(K(e.value));V(e,A=>{const k=oe(ne.value,e.value);k&&(ne.value=K(A),g("onThemeChange",k))},{deep:!0});const se=C(K(n.value));return V(n,A=>{const k=oe(se.value,A);k&&(se.value=K(n.value),g("onSettingsChange",k))},{deep:!0}),{nodes:f,edges:E,getNode:B,getEdge:D,addNode:S,addEdge:I,moveNode:M,editEdgeLabel:O,removeNode:L,removeEdge:_,bulkAddNode:q,bulkRemoveNode:P,bulkAddEdge:z,bulkRemoveEdge:R,getSchemaItemsByCoordinates:r,getNodeByCoordinates:W,eventBus:y,subscribe:d,unsubscribe:b,emit:g,updateAggregator:v,aggregator:a,theme:e,getTheme:t,themeMap:u,settings:n,reset:Te,canvas:s,canvasFocused:N,graphAtMousePosition:m,updateGraphAtMousePosition:c,...i}},Nt={focus:!0},xt={focus:!0},le=100,fe=3,At=(s,o={})=>{const e=St(s,o),u=C([]),t=C([]),n=i=>{u.value.push(i),u.value.length>le&&u.value.shift()},y=i=>{t.value.push(i),t.value.length>le&&t.value.shift()};e.subscribe("onNodeAdded",(i,{history:c})=>{c&&n({action:"add",affectedItems:[{graphType:"node",data:i}]})}),e.subscribe("onBulkNodeAdded",(i,{history:c})=>{c&&n({action:"add",affectedItems:i.map(p=>({graphType:"node",data:p}))})}),e.subscribe("onNodeRemoved",(i,c,{history:p})=>{if(!p)return;const x=c.map(h=>({graphType:"edge",data:h}));n({action:"remove",affectedItems:[{graphType:"node",data:i},...x]})}),e.subscribe("onBulkNodeRemoved",(i,c,{history:p})=>{if(!p)return;const x=i.map(a=>({graphType:"node",data:a})),h=c.map(a=>({graphType:"edge",data:a}));n({action:"remove",affectedItems:[...x,...h]})}),e.subscribe("onEdgeLabelEdited",(i,c,{history:p})=>{p&&n({action:"edit",affectedItems:[{graphType:"edge",data:{id:i.id,from:c,to:i.label}}]})}),e.subscribe("onEdgeAdded",(i,{history:c})=>{c&&n({action:"add",affectedItems:[{graphType:"edge",data:i}]})}),e.subscribe("onBulkEdgeAdded",(i,{history:c})=>{c&&n({action:"add",affectedItems:i.map(p=>({graphType:"edge",data:p}))})}),e.subscribe("onEdgeRemoved",(i,{history:c})=>{c&&n({action:"remove",affectedItems:[{graphType:"edge",data:i}]})}),e.subscribe("onBulkEdgeRemoved",(i,{history:c})=>{c&&n({action:"remove",affectedItems:i.map(p=>({graphType:"edge",data:p}))})});const d=C();e.subscribe("onGroupDragStart",(i,c)=>{d.value={startingCoordinates:c,nodes:i}}),e.subscribe("onGroupDrop",(i,c)=>{if(!d.value)throw new Error("dropped a group we didn't know was being dragged");if(d.value.nodes.length!==i.length)throw new Error("group size mismatch");const p=d.value.startingCoordinates.y-c.y,x=d.value.startingCoordinates.x-c.x;Math.sqrt(p**2+x**2)<fe||n({action:"move",affectedItems:d.value.nodes.map(a=>({graphType:"node",data:{id:a.id,from:{x:a.x+x,y:a.y+p},to:{x:a.x,y:a.y}}}))})});const b=C();e.subscribe("onNodeDragStart",i=>{b.value={id:i.id,from:{x:i.x,y:i.y},to:{x:i.x,y:i.y}}}),e.subscribe("onNodeDrop",i=>{if(!b.value)throw new Error("dropped a node we didn't know was being dragged");if(b.value.id!==i.id)throw new Error("node ID mismatch");b.value.to={x:i.x,y:i.y};const c=b.value.from.y-b.value.to.y,p=b.value.from.x-b.value.to.x;Math.sqrt(c**2+p**2)<fe||n({action:"move",affectedItems:[{graphType:"node",data:b.value}]})});const g=(i={})=>{const c=u.value.pop();if(c)return y(c),f(c),e.emit("onUndo",c,{...Nt,...i}),c},N=(i={})=>{const c=t.value.pop();if(c)return n(c),E(c),e.emit("onRedo",c,{...xt,...i}),c},f=i=>{if(i.action==="add")for(const c of i.affectedItems)c.graphType==="node"?e.removeNode(c.data.id,{history:!1}):c.graphType==="edge"&&e.removeEdge(c.data.id,{history:!1});else if(i.action==="remove")for(const c of i.affectedItems)c.graphType==="node"?e.addNode(c.data,{history:!1,focus:!1}):c.graphType==="edge"&&e.addEdge(c.data,{history:!1,focus:!1});else if(i.action==="move"){for(const c of i.affectedItems)if(c.graphType==="node"){const{from:p,id:x}=c.data;e.moveNode(x,{x:p.x,y:p.y})}}else if(i.action==="edit")for(const c of i.affectedItems)e.editEdgeLabel(c.data.id,c.data.from,{history:!1})},E=i=>{if(i.action==="add")for(const c of i.affectedItems)c.graphType==="node"?e.addNode(c.data,{history:!1,focus:!1}):c.graphType==="edge"&&e.addEdge(c.data,{history:!1,focus:!1});else if(i.action==="remove")for(const c of i.affectedItems)c.graphType==="node"?e.removeNode(c.data.id,{history:!1}):c.graphType==="edge"&&e.removeEdge(c.data.id,{history:!1});else if(i.action==="move"){for(const c of i.affectedItems)if(c.graphType==="node"){const{to:p,id:x}=c.data;e.moveNode(x,{x:p.x,y:p.y})}}else if(i.action==="edit")for(const c of i.affectedItems)e.editEdgeLabel(c.data.id,c.data.to,{history:!1})},m=()=>{u.value=[],t.value=[]};return{...e,undo:g,redo:N,canUndo:U(()=>u.value.length>0),canRedo:U(()=>t.value.length>0),undoStack:u,redoStack:t,addToUndoStack:n,addToRedoStack:y,clearHistory:m}},wt=["node","edge"],Ct="use-focus-graph",It=(s,o={})=>{const e=At(s,o),{setTheme:u}=me(e,Ct),t=C(new Set),n=C(!1),y=a=>{const v=a.filter(w=>!e.settings.value.focusBlacklist.includes(w));if(v.length===t.value.size&&v.every(w=>t.value.has(w)))return;const T=new Set([...t.value]);t.value=new Set(v),e.emit("onFocusChange",t.value,T)},d=a=>{if(t.value.has(a)||e.settings.value.focusBlacklist.includes(a))return;const l=new Set([...t.value]);t.value.add(a),e.emit("onFocusChange",t.value,l)},b=a=>{var r,l;const v=Ee(e.canvas);(l=(r=a.shape).activateTextArea)==null||l.call(r,v,T=>{const w=e.getEdge(a.id);if(!w)throw new Error("textarea only implemented for edges");const B=e.settings.value.edgeInputToLabel(T);B===void 0||w.label===B||e.editEdgeLabel(w.id,B)})},g=()=>{const a=Array.from(t.value),v=a.filter(r=>e.getNode(r)||e.getEdge(r));v.length!==a.length&&y(v)},N=({items:a,coords:v})=>{var B,D;const r=a.at(-1);if(!r)return n.value?void 0:f();if(((D=(B=r.shape).textHitbox)==null?void 0:D.call(B,v))&&e.settings.value.edgeLabelsEditable&&r.graphType==="edge")return f(),b(r);wt.some(S=>S===r.graphType)&&(n.value?d(r.id):y([r.id]))},f=()=>y([]),E=()=>{const a=e.nodes.value.map(r=>r.id),v=e.edges.value.map(r=>r.id);y([...a,...v])},m=({id:a},{focus:v})=>{v&&y([a])},i=a=>t.value.has(a);u("nodeColor",a=>{if(i(a.id))return e.getTheme("nodeFocusColor",a)}),u("nodeBorderColor",a=>{if(i(a.id))return e.getTheme("nodeFocusBorderColor",a)}),u("nodeTextColor",a=>{if(i(a.id))return e.getTheme("nodeFocusTextColor",a)}),u("edgeColor",a=>{if(i(a.id))return e.getTheme("edgeFocusColor",a)}),u("edgeTextColor",a=>{if(i(a.id))return e.getTheme("edgeFocusTextColor",a)}),u("nodeAnchorColor",a=>{if(i(a.id))return e.getTheme("nodeAnchorColorWhenParentFocused",a)});const c=a=>{a.key==="Shift"&&(n.value=!0)},p=a=>{a.key==="Shift"&&(n.value=!1)},x=()=>{e.subscribe("onNodeAdded",m),e.subscribe("onEdgeAdded",m),e.subscribe("onMouseDown",N),e.subscribe("onGraphReset",f),e.subscribe("onKeyDown",c),e.subscribe("onKeyUp",p),e.subscribe("onStructureChange",g)},h=()=>{e.unsubscribe("onNodeAdded",m),e.unsubscribe("onEdgeAdded",m),e.unsubscribe("onMouseDown",N),e.unsubscribe("onGraphReset",f),e.unsubscribe("onKeyDown",c),e.unsubscribe("onKeyUp",p),e.unsubscribe("onStructureChange",g),f()};return e.subscribe("onSettingsChange",a=>{a.focusable===!1?h():a.focusable===!0&&x()}),e.settings.value.focusable&&x(),{...e,focusedItemIds:ee(t),setFocus:y,resetFocus:f,addToFocus:d,isFocused:i,focusAll:E,focusedNodes:U(()=>e.nodes.value.filter(a=>i(a.id))),focusedEdges:U(()=>e.edges.value.filter(a=>i(a.id)))}},Mt=(s,o={})=>{const e=It(s,o),u=C(),t=({items:g,coords:N})=>{const f=g.at(-1);if(!f||f.graphType!=="node")return;const E=e.getNode(f.id);E&&(u.value={node:E,coords:N},e.emit("onNodeDragStart",E))},n=()=>{u.value&&(e.emit("onNodeDrop",u.value.node),u.value=void 0)},y=({coords:g})=>{if(!u.value)return;const{node:N,coords:f}=u.value,E=g.x-f.x,m=g.y-f.y;e.moveNode(N.id,{x:N.x+E,y:N.y+m}),u.value.coords=g},d=()=>{e.subscribe("onMouseDown",t),e.subscribe("onMouseUp",n),e.subscribe("onMouseMove",y)},b=()=>{e.unsubscribe("onMouseDown",t),e.unsubscribe("onMouseUp",n),e.unsubscribe("onMouseMove",y),u.value&&n()};return e.subscribe("onSettingsChange",g=>{g.draggable===!1?b():g.draggable===!0&&d()}),e.settings.value.draggable&&d(),{...e,activeDragNode:U(()=>{var g;return(g=u.value)==null?void 0:g.node})}},Dt=(s,o={})=>{const e=Mt(s,o),u=C(),t=C(),n=()=>{u.value=void 0,t.value=void 0},y=r=>{if(e.activeDragNode.value)return[];const{getTheme:l}=e,T=l("nodeAnchorColor",r),w=l("nodeAnchorRadius",r),B=[];for(const D of d.value){const{x:S,y:I}=D,M={at:{x:S,y:I},radius:w,color:T};t.value&&t.value.direction===D.direction&&(M.at.x=t.value.x,M.at.y=t.value.y);const O=be(M);B.push({id:D.id,graphType:"node-anchor",shape:O,priority:1/0})}return B},d=C([]),b=r=>{if(!r)return d.value=[];const{getTheme:l}=e,T=l("nodeAnchorRadius",r),w=l("nodeSize",r),B=l("nodeBorderWidth",r),D=w-T/3+B/2;d.value=[{x:r.x,y:r.y-D,direction:"north"},{x:r.x+D,y:r.y,direction:"east"},{x:r.x,y:r.y+D,direction:"south"},{x:r.x-D,y:r.y,direction:"west"}].map(S=>({...S,id:Z()}))},g=({items:r})=>{const l=r.at(-1);if(!l||l.graphType!=="node-anchor")return;const{id:T}=l;return d.value.find(w=>w.id===T)},N=()=>{if(!u.value||!t.value)return;const{x:r,y:l}=t.value,T={x:u.value.x,y:u.value.y},w={x:r,y:l},{getTheme:B}=e,D=B("linkPreviewColor",u.value,t.value),S=B("linkPreviewWidth",u.value,t.value);return{id:"link-preview",graphType:"link-preview",shape:ye({start:T,end:w,color:D,width:S})}},f=({items:r})=>{if(t.value)return;const l=r.at(-1);if(!l)return n();if(l.graphType!=="node")return;const T=e.getNode(l.id);if(!T)throw new Error("node in aggregator but not in graph");const w=e.isFocused(T.id),B=e.focusedNodes.value.length>1;if(w&&B)return n();u.value=T,b(T)},E=r=>{if(!u.value)return;const l=g(r);l&&(t.value=l,e.emit("onNodeAnchorDragStart",u.value,l))},m=({coords:r})=>{if(!t.value)return;const{x:l,y:T}=r;t.value.x=l,t.value.y=T},i=()=>{if(t.value){if(!u.value)throw new Error("active anchor without parent node")}else return;e.emit("onNodeAnchorDrop",u.value,t.value),n()},c=r=>{if(!u.value)return r;const l=y(u.value);for(const T of l)r.push(T);return r},p=r=>{var D;if(!u.value||!t.value)return r;const{id:l}=u.value;pe(l,r);const T=(D=r.find(S=>S.id===l))==null?void 0:D.priority;if(!T)return r;const w=N();if(!w)return r;const B={...w,priority:T-.1};return r.push(B),r};e.updateAggregator.push(c),e.updateAggregator.push(p);const x=r=>{var l;((l=u.value)==null?void 0:l.id)===r.id&&n()},h=()=>{if(!u.value)return;const r=e.isFocused(u.value.id),l=e.focusedNodes.value.length>1;r&&l&&n()},a=()=>{e.subscribe("onNodeRemoved",x),e.subscribe("onNodeMoved",n),e.subscribe("onNodeDrop",b),e.subscribe("onMouseMove",f),e.subscribe("onMouseMove",m),e.subscribe("onMouseDown",E),e.subscribe("onMouseUp",i),e.subscribe("onFocusChange",h)},v=()=>{e.unsubscribe("onNodeRemoved",x),e.unsubscribe("onNodeMoved",n),e.unsubscribe("onNodeDrop",b),e.unsubscribe("onMouseMove",f),e.unsubscribe("onMouseMove",m),e.unsubscribe("onMouseDown",E),e.unsubscribe("onMouseUp",i),e.unsubscribe("onFocusChange",h)};return e.subscribe("onSettingsChange",r=>{r.nodeAnchors===!0?a():r.nodeAnchors===!1&&v()}),e.settings.value.nodeAnchors&&a(),{...e,nodeAnchorActiveAnchor:ee(t),nodeAnchorParentNode:ee(u)}},Bt="use-marquee-graph",kt={THEME_ID:Bt},Rt=(s,o={})=>{const e=Dt(s,o),u=C(),t=C(),n=C(),{setTheme:y,removeTheme:d}=me(e,kt.THEME_ID),b=()=>y("nodeAnchorColor",J.TRANSPARENT),g=()=>d("nodeAnchorColor"),N=S=>{const{width:I,height:M}=S;return Math.abs(I*M)},f=({items:S,coords:I})=>{const M=S.at(-1);(M==null?void 0:M.graphType)!=="encapsulated-node-box"&&g(),M||p(I)},E=({items:S,coords:I})=>{if(!n.value)return;const M=S.at(-1);if((M==null?void 0:M.graphType)!=="encapsulated-node-box")return;const O=I.x-n.value.x,L=I.y-n.value.y;n.value=I;for(const _ of e.focusedNodes.value)e.moveNode(_.id,{x:_.x+O,y:_.y+L});a()},m=({items:S,coords:I})=>{if(u.value)return;const M=S.at(-1);(M==null?void 0:M.graphType)==="encapsulated-node-box"&&(n.value=I,e.emit("onGroupDragStart",e.focusedNodes.value,I))},i=()=>{n.value&&(e.emit("onGroupDrop",e.focusedNodes.value,n.value),n.value=void 0)},c=()=>t.value={at:{x:1/0,y:1/0},width:0,height:0},p=S=>{b(),e.graphCursorDisabled.value=!0,u.value={at:S,width:0,height:0},c()},x=()=>{u.value&&(u.value=void 0,e.graphCursorDisabled.value=!1,g())},h=S=>{if(N(S)<100)return;const M=[];for(const{id:O,shape:L,graphType:_}of e.aggregator.value){const{marqueeSelectableGraphTypes:q}=e.settings.value;if(!q.includes(_))continue;L.efficientHitbox(S)&&M.push(O)}e.setFocus(M)},a=()=>{if(!t.value)return;if(e.focusedNodes.value.length<2)return c();let S=1/0,I=1/0,M=-1/0,O=-1/0;for(const L of e.focusedNodes.value){const _=e.getTheme("nodeSize",L),q=e.getTheme("nodeBorderWidth",L),P=_+q/2,{x:z,y:R}=L;S=Math.min(S,z-P),I=Math.min(I,R-P),M=Math.max(M,z+P),O=Math.max(O,R+P)}S<1/0&&I<1/0&&M>-1/0&&O>-1/0?(t.value.at.x=S,t.value.at.y=I,t.value.width=M-S,t.value.height=O-I):(t.value.width=0,t.value.height=0)},v=({coords:S})=>{if(!u.value)return;const{x:I,y:M}=S;u.value.width=I-u.value.at.x,u.value.height=M-u.value.at.y,h(u.value)},r=S=>({id:"marquee-box",graphType:"marquee-box",shape:ae({...S,color:e.getTheme("marqueeSelectionBoxColor"),stroke:{color:e.getTheme("marqueeSelectionBoxBorderColor"),width:2}}),priority:1/0}),l=S=>{if(!u.value)return S;const I=r(u.value);return S.push(I),S},T=S=>({id:"encapsulated-node-box",graphType:"encapsulated-node-box",shape:ae({...S,color:e.getTheme("marqueeEncapsulatedNodeBoxColor"),stroke:{color:e.getTheme("marqueeEncapsulatedNodeBoxBorderColor"),width:2}}),priority:1/0}),w=S=>{if(!t.value)return S;const I=T(t.value);return S.push(I),S};e.updateAggregator.push(w),e.updateAggregator.push(l);const B=()=>{e.subscribe("onFocusChange",a),e.subscribe("onMouseDown",f),e.subscribe("onMouseUp",x),e.subscribe("onContextMenu",x),e.subscribe("onMouseMove",v),e.subscribe("onMouseDown",m),e.subscribe("onMouseUp",i),e.subscribe("onMouseMove",E),e.subscribe("onUndo",a),e.subscribe("onRedo",a)},D=()=>{e.unsubscribe("onFocusChange",a),e.unsubscribe("onMouseDown",f),e.unsubscribe("onMouseUp",x),e.unsubscribe("onContextMenu",x),e.unsubscribe("onMouseMove",v),e.unsubscribe("onMouseDown",m),e.unsubscribe("onMouseUp",i),e.unsubscribe("onMouseMove",E),e.unsubscribe("onUndo",a),e.unsubscribe("onRedo",a),u.value&&x()};return e.subscribe("onSettingsChange",S=>{S.marquee===!0?B():S.marquee===!1&&D()}),e.settings.value.marquee&&B(),{...e,updateEncapsulatedNodeBox:a}},Ot=(s,o={})=>{const e=Rt(s,o),u=C(Re[0]),t=C(Oe[1]),n=C(!1),y=C(new Set),d=C([]),b=C([]),g=C(!1),N=C(),f=C(!1),E=()=>{b.value=[]},m=({coords:a})=>{g.value=!0,N.value=a,d.value=[a]},i=({coords:a})=>{if(!(!g.value||!N.value)){if(n.value){const v=b.value.filter(r=>j.scribble(r).hitbox(a));for(const r of v)y.value.add(r.id);return}N.value=a,d.value.push(a)}},c=()=>{if(g.value&&(g.value=!1,N.value=void 0,d.value.length!==0)){if(n.value){b.value=b.value.filter(a=>!y.value.has(a.id)),y.value.clear();return}b.value.push({id:Z(),type:"draw",points:d.value,color:u.value,brushWeight:t.value}),d.value=[]}};V(n,()=>{e.canvas.value&&(e.canvas.value.style.cursor=n.value?"none":"crosshair")});const p=a=>{if(!f.value)return a;if(n.value){const v=j.circle({at:e.graphAtMousePosition.value.coords,radius:10,color:J.TRANSPARENT,stroke:{color:J.WHITE+"60",width:2}});a.push({graphType:"annotation",id:v.id,shape:v,priority:5050})}else if(d.value.length>0){const v=j.scribble({type:"draw",points:d.value,color:u.value,brushWeight:t.value});a.push({graphType:"annotation",id:v.id,shape:v,priority:5001})}for(const v of b.value){const r=y.value.has(v.id);a.push({graphType:"annotation",id:v.id,shape:j.scribble({...v,color:v.color+(r?"50":"")}),priority:5e3})}return a};return e.updateAggregator.push(p),{...e,clearAnnotations:E,annotationActive:f,annotationErasing:n,annotationColor:u,annotationBrushWeight:t,activateAnnotation:()=>{e.canvas.value&&(f.value=!0,e.settings.value.userEditable=!1,e.settings.value.marquee=!1,e.settings.value.focusable=!1,e.graphCursorDisabled.value=!0,e.canvas.value.style.cursor="crosshair",e.subscribe("onMouseDown",m),e.subscribe("onMouseMove",i),e.subscribe("onMouseUp",c))},deactivateAnnotation:()=>{e.canvas.value&&(f.value=!1,n.value=!1,e.settings.value.userEditable=!0,e.settings.value.marquee=!0,e.settings.value.focusable=!0,e.graphCursorDisabled.value=!1,e.canvas.value.style.cursor="default",e.unsubscribe("onMouseDown",m),e.unsubscribe("onMouseMove",i),e.unsubscribe("onMouseUp",c))}}},Ft=(s=!1)=>{const o=d=>d.key===" "?"Space":d.key.length>1||s?d.key:d.key.toUpperCase(),e=C(""),u=U(()=>{let d;return e.value.split("+").filter(b=>{const g=b===d;return d=b,!g}).join("+")}),t=d=>{e.value.length>0&&(e.value+="+"),e.value+=o(d)},n=()=>{e.value=""},y=d=>u.value===d;return document.addEventListener("keydown",t),document.addEventListener("keyup",n),he(()=>{document.removeEventListener("keydown",t),document.removeEventListener("keyup",n)}),{isPressed:y,currentKeyString:e}},Lt=(s,o={})=>{const e=Ot(s,o),u=({coords:m,event:i})=>{e.addNode(m),setTimeout(()=>e.updateGraphAtMousePosition(i),10)},t=(m,i)=>{const p=e.getSchemaItemsByCoordinates(i).findLast(h=>h.graphType==="node");if(!p)return;const x=e.getNode(p.id);if(x&&!(e.settings.value.userAddedEdgeRuleNoSelfLoops&&m.id===x.id)){if(e.settings.value.userAddedEdgeRuleOneEdgePerPath){const h=e.edges.value.find(r=>r.from===m.id&&r.to===x.id),a=e.edges.value.find(r=>r.from===x.id&&r.to===m.id);if(h||a)return}e.addEdge({from:m.id,to:x.id,label:e.settings.value.userAddedEdgeLabel})}},n=()=>{e.bulkRemoveNode([...e.focusedItemIds.value]),e.bulkRemoveEdge([...e.focusedItemIds.value])},y={Mac:{"Meta+Z":()=>e.undo(),"Shift+Meta+Z":()=>e.redo(),Backspace:n,"Meta+A":e.focusAll,Escape:e.resetFocus},Windows:{"Control+Z":()=>e.undo(),"Shift+Control+Z":()=>e.redo(),Backspace:n,"Control+A":e.focusAll,Escape:e.resetFocus}},d=window.navigator.userAgent.includes("Mac")?"Mac":"Windows",{isPressed:b}=Ft(),N={onDblClick:u,onKeyDown:()=>{if(e.settings.value.userEditable===!1||e.canvasFocused.value===!1)return;const m=y[d];for(const i in m)b(i)&&m[i]()},onNodeAnchorDrop:t},f=()=>{for(const m in N)e.subscribe(m,N[m]);e.settings.value.nodeAnchors=!0,e.settings.value.edgeLabelsEditable=!0},E=()=>{for(const m in N)e.unsubscribe(m,N[m]);e.settings.value.nodeAnchors=!1,e.settings.value.edgeLabelsEditable=!1};return e.settings.value.userEditable&&f(),e.subscribe("onSettingsChange",m=>{m.userEditable===!0?f():m.userEditable===!1&&E()}),e},_t=(s,o={})=>{const e=Lt(s,o),u={get:()=>JSON.parse(localStorage.getItem(e.settings.value.persistentStorageKey+"-nodes")??"[]"),set:f=>{const E=f.filter(m=>!e.settings.value.persistentBlacklist.has(m.id));localStorage.setItem(e.settings.value.persistentStorageKey+"-nodes",JSON.stringify(E))}},t={get:()=>JSON.parse(localStorage.getItem(e.settings.value.persistentStorageKey+"-edges")??"[]"),set:f=>{const E=f.filter(m=>!e.settings.value.persistentBlacklist.has(m.id));localStorage.setItem(e.settings.value.persistentStorageKey+"-edges",JSON.stringify(E))}},n=async()=>{await new Promise(f=>setTimeout(f,10)),u.set(e.nodes.value),t.set(e.edges.value)},y=()=>{e.nodes.value=u.get(),e.edges.value=t.get(),queueMicrotask(()=>e.emit("onStructureChange",e.nodes.value,e.edges.value))},d=["onStructureChange","onNodeDrop","onGroupDrop","onGraphReset"],b=()=>{d.forEach(f=>e.subscribe(f,n))},g=()=>{d.forEach(f=>e.unsubscribe(f,n))},N=()=>{g()};return e.subscribe("onSettingsChange",f=>{if(N(),"persistent"in f&&!f.persistent)return;if("persistent"in f&&f.persistent){y(),b();return}"persistentStorageKey"in f&&y(),b()}),e.settings.value.persistent&&(y(),b()),{...e,trackGraphState:n}},Gt=s=>({getConnectedNodes:o=>$(o,s),getConnectedEdges:o=>ve(o,s),getInboundEdges:o=>Fe(o,s),getOutboundEdges:o=>Le(o,s),isEdgeFlowingIntoNode:(o,e)=>_e(o,e,s),isEdgeFlowingOutOfNode:(o,e)=>Ge(o,e,s),getEdgesAlongPath:(o,e)=>ge(o,e,s),getEdgeWeight:o=>Pe(o,s),getWeightBetweenNodes:(o,e)=>Ue(o,e,s)}),Wt=(s,o={})=>{const e=_t(s,o),u=Gt(e),t={...e,helpers:u},n=K((o==null?void 0:o.theme)??{});return Ye(t,n),t},Ht=We({__name:"Graph",props:{graph:{}},emits:["graphRef"],setup(s,{emit:o}){const e=s,u=o,t=d=>u("graphRef",d),n=C(e.graph.getTheme("graphBgPatternColor")),y=C(e.graph.getTheme("graphBgColor"));return e.graph.subscribe("onThemeChange",d=>{const{graphBgPatternColor:b,graphBgColor:g}=d;b&&(n.value=b),g&&(y.value=g)}),(d,b)=>(He(),qe(Je,{onCanvasRef:t,color:y.value,"pattern-color":n.value},null,8,["color","pattern-color"]))}});export{te as T,Ht as _,ot as i,Wt as u};
