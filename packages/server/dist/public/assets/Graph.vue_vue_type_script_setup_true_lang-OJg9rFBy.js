var xe=Object.defineProperty;var we=(e,o,t)=>o in e?xe(e,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[o]=t;var j=(e,o,t)=>we(e,typeof o!="symbol"?o+"":o,t);import{T as Ie,O as Be,A as K,b4 as X,b5 as fe,b6 as De,b7 as Me,b8 as Re,b9 as _e,ba as ve,bb as ke,bc as Le,x as S,bd as Fe,H as D,g as B,z as he,aa as V,be as Oe,ao as Pe,ap as Ue,bf as Ge,bg as ge,u as me,B as Q,y as We,a0 as He,d as qe,C as Ke,o as ze}from"./index-X-1QUzvR.js";import{c as be,a as je,b as Ye,l as pe,e as Ve,g as ye,r as ne,s as Y,_ as Je}from"./ResponsiveCanvas.vue_vue_type_script_setup_true_lang-_FAHmvQA.js";const Ze="auto",Xe=e=>{const o=Ie(),t=Be("preferred-theme",Ze);return K(o,()=>{t.value==="auto"&&(e.themeName.value=o.value?"dark":"light")},{immediate:!0}),K(t,()=>{t.value==="auto"?e.themeName.value=o.value?"dark":"light":e.themeName.value=t.value},{immediate:!0}),{preferredTheme:t}},Qe=e=>({getConnectedNodes:o=>X(o,e),getConnectedEdges:o=>fe(o,e),getInboundEdges:o=>De(o,e),getOutboundEdges:o=>Me(o,e),isEdgeFlowingIntoNode:(o,t)=>Re(o,t,e),isEdgeFlowingOutOfNode:(o,t)=>_e(o,t,e),getEdgesAlongPath:(o,t)=>ve(o,t,e),getEdgeWeight:o=>ke(o,e),getWeightBetweenNodes:(o,t)=>Le(o,t,e)}),$e=(e,o)=>{const t=o("nodeColor",e),c=o("nodeBorderColor",e),r=o("nodeSize",e),n=o("nodeBorderWidth",e),u=o("nodeText",e),i=o("nodeTextSize",e),d=o("nodeTextColor",e),l=o("nodeShape",e),b=be({at:{x:e.x,y:e.y},radius:r,color:t,stroke:{color:c,width:n},textArea:{text:{content:u,fontSize:i,fontWeight:"bold",color:d},color:S.TRANSPARENT}}),C=je({at:{x:e.x-r,y:e.y-r},size:r*2,color:t,stroke:{color:c,width:n},textArea:{text:{content:u,fontSize:i,fontWeight:"bold",color:d},color:S.TRANSPARENT}});return{shape:l==="circle"?b:C,id:e.id,graphType:"node"}},eo=1.618,se=2,oo=(e,o)=>{const{displayEdgeLabels:t,isGraphDirected:c}=o.settings.value,[r,n]=X(e.id,o),i=ve(r.id,n.id,o).length>1,d=n===r,l=o.getTheme("nodeBorderWidth",r),b=o.getTheme("nodeBorderWidth",n),C=o.getTheme("nodeSize",r),s=o.getTheme("nodeSize",n),a=Math.atan2(n.y-r.y,n.x-r.x),m=b/2+se,x={x:(s+m)*Math.cos(a),y:(s+m)*Math.sin(a)},E={x:r.x,y:r.y},h={x:n.x-(c?x.x:0),y:n.y-(c?x.y:0)},v=o.getTheme("edgeWidth",e),p=v*1.2;i&&(E.x+=Math.cos(a+Math.PI/2)*p,E.y+=Math.sin(a+Math.PI/2)*p,h.x+=Math.cos(a+Math.PI/2)*p,h.y+=Math.sin(a+Math.PI/2)*p);const f=Fe(E,o.edges.value.filter(L=>(L.from===r.id||L.to===n.id)&&L.from!==L.to).map(L=>{const[G,q]=X(L.id,o);return r.id===G.id?{x:q.x,y:q.y}:{x:G.x,y:G.y}}).filter((L,G,q)=>G===q.findIndex(P=>P.x===L.x&&P.y===L.y))),g=o.getTheme("edgeColor",e),T=o.getTheme("edgeTextColor",e),I=o.getTheme("graphBgColor"),y=o.getTheme("edgeText",e),A=o.getTheme("edgeTextSize",e),w=o.getTheme("edgeTextFontWeight",e),R=t?{color:I,activeColor:I,text:{content:y,color:T,fontSize:A,fontWeight:w}}:void 0,k=(C+l)*eo,U=k-(C+l/2)-se;if(d)return{shape:Ye({spacing:v*1.2,at:{x:r.x,y:r.y},upDistance:k,downDistance:U,rotation:f,lineWidth:v,color:g,textArea:R}),id:e.id,graphType:"edge"};const O=C+l/2+s+b/2,H=(r.x-n.x)**2+(r.y-n.y)**2;return O**2>H?void 0:c?{shape:Ve({start:E,end:h,width:v,textOffsetFromCenter:(C+l/2)/2,color:g,textArea:R}),id:e.id,graphType:"edge"}:{shape:pe({start:E,end:h,width:v,color:g,textArea:R}),id:e.id,graphType:"edge"}},ee={nodeShape:"circle",nodeSize:35,nodeBorderWidth:8,nodeTextSize:24,nodeAnchorRadius:Math.ceil(Math.sqrt(35)*2),edgeWidth:10,edgeTextSize:20,nodeText:({label:e})=>e,edgeText:({label:e})=>e,edgeTextFontWeight:"bold",linkPreviewWidth:10},to="rgb(100, 60, 70)",no={nodeBorderColor:S.BLACK,nodeColor:S.STONE_600,nodeTextColor:S.WHITE,nodeFocusBorderColor:S.RED_700,nodeFocusColor:to,nodeFocusTextColor:S.WHITE,edgeColor:S.STONE_900,edgeFocusColor:S.RED_700,edgeFocusTextColor:S.WHITE,edgeTextColor:S.WHITE,graphBgColor:S.GRAY_600,graphBgPatternColor:S.WHITE+"15",nodeAnchorColorWhenParentFocused:S.RED_800,nodeAnchorColor:S.GRAY_900,linkPreviewColor:S.BLACK,marqueeSelectionBoxColor:S.WHITE+"15",marqueeSelectionBoxBorderColor:S.WHITE,marqueeEncapsulatedNodeBoxBorderColor:S.RED_700,marqueeEncapsulatedNodeBoxColor:S.RED_700+"20",...ee},so={nodeColor:S.GRAY_50,nodeBorderColor:S.GRAY_800,nodeFocusBorderColor:S.BLUE_600,nodeFocusColor:S.BLUE_100,nodeTextColor:S.GRAY_900,nodeFocusTextColor:S.GRAY_900,edgeColor:S.GRAY_800,edgeTextColor:S.GRAY_900,edgeFocusColor:S.BLUE_600,edgeFocusTextColor:S.BLACK,graphBgColor:S.GRAY_200,graphBgPatternColor:S.BLACK+"15",nodeAnchorColor:S.BLACK,nodeAnchorColorWhenParentFocused:S.BLUE_900,linkPreviewColor:S.BLACK,marqueeSelectionBoxColor:S.BLUE_300+"15",marqueeSelectionBoxBorderColor:S.BLUE_500,marqueeEncapsulatedNodeBoxBorderColor:S.BLUE_700,marqueeEncapsulatedNodeBoxColor:S.BLUE_700+"05",...ee},ro={nodeColor:S.PINK_100,nodeBorderColor:S.PINK_400,nodeFocusBorderColor:S.PURPLE_600,nodeFocusColor:S.PURPLE_200,nodeTextColor:S.PINK_600,nodeFocusTextColor:S.PURPLE_900,edgeColor:S.PINK_600,edgeTextColor:S.PINK_600,edgeFocusColor:S.PURPLE_600,edgeFocusTextColor:S.PURPLE_600,graphBgColor:S.PINK_300,graphBgPatternColor:S.WHITE+"50",nodeAnchorColor:S.PINK_500,nodeAnchorColorWhenParentFocused:S.PURPLE_700,linkPreviewColor:S.PINK_900,marqueeSelectionBoxColor:S.PINK_300+"15",marqueeSelectionBoxBorderColor:S.PINK_500,marqueeEncapsulatedNodeBoxBorderColor:S.PINK_700,marqueeEncapsulatedNodeBoxColor:S.PINK_700+"05",...ee},Se={light:so,dark:no,girl:ro},dt=(e,o)=>({nodeSize:e("nodeSize",o),nodeBorderWidth:e("nodeBorderWidth",o),nodeColor:e("nodeColor",o),nodeBorderColor:e("nodeBorderColor",o),nodeTextSize:e("nodeTextSize",o),nodeTextColor:e("nodeTextColor",o),nodeText:e("nodeText",o),nodeShape:e("nodeShape",o)}),ao=()=>({nodeSize:[],nodeBorderWidth:[],nodeColor:[],nodeBorderColor:[],nodeFocusColor:[],nodeFocusBorderColor:[],nodeText:[],nodeFocusTextColor:[],nodeTextSize:[],nodeTextColor:[],nodeShape:[],edgeColor:[],edgeWidth:[],edgeText:[],edgeTextSize:[],edgeTextColor:[],edgeFocusTextColor:[],edgeTextFontWeight:[],edgeFocusColor:[],graphBgColor:[],graphBgPatternColor:[],nodeAnchorRadius:[],nodeAnchorColor:[],nodeAnchorColorWhenParentFocused:[],linkPreviewColor:[],linkPreviewWidth:[],marqueeSelectionBoxColor:[],marqueeSelectionBoxBorderColor:[],marqueeEncapsulatedNodeBoxColor:[],marqueeEncapsulatedNodeBoxBorderColor:[]}),co=e=>Object.prototype.toString.call(e)==="[object Object]",Ee=(e,o)=>{const t={};if(!e)return o;if(!o)return null;const c=Object.keys(e),r=Object.keys(o);for(const n of r)c.includes(n)||(t[n]=o[n]);for(const n of c){if(co(e[n])){const u=Ee(e[n],o[n]);u&&(t[n]=u);continue}if(Array.isArray(e[n])){JSON.stringify(e[n])!==JSON.stringify(o[n])&&(t[n]=o[n]);continue}else e[n]!==o[n]&&(t[n]=o[n])}return Object.keys(t).length?t:null},$=e=>{const o={...e};for(const t in o)typeof o[t]=="object"&&(o[t]=$(o[t]));return o},io=e=>({subscribe:(o,t)=>e[o].add(t),unsubscribe:(o,t)=>e[o].delete(t),emit:(o,...t)=>{for(const c of e[o])c(...t)}}),uo=()=>({onStructureChange:new Set,onNodeAdded:new Set,onBulkNodeAdded:new Set,onNodeRemoved:new Set,onBulkNodeRemoved:new Set,onNodeMoved:new Set,onBulkNodeMoved:new Set,onEdgeAdded:new Set,onBulkEdgeAdded:new Set,onEdgeRemoved:new Set,onBulkEdgeRemoved:new Set,onEdgeLabelEdited:new Set,onRepaint:new Set,onNodeHoverChange:new Set,onGraphLoaded:new Set,onGraphReset:new Set,onClick:new Set,onMouseDown:new Set,onMouseUp:new Set,onMouseMove:new Set,onDblClick:new Set,onContextMenu:new Set,onKeyDown:new Set,onKeyUp:new Set,onThemeChange:new Set,onSettingsChange:new Set,onUndo:new Set,onRedo:new Set,onFocusChange:new Set,onNodeDragStart:new Set,onNodeDrop:new Set,onNodeAnchorDragStart:new Set,onNodeAnchorDrop:new Set,onGroupDragStart:new Set,onGroupDrop:new Set}),re=e=>e==null,lo=e=>{const o=e.trim().split("/").filter(Boolean);if(o.length!==2)return!1;const[t,c]=o.map(Number);return!(re(t)||re(c))},fo=e=>{if(!lo(e))return;const o=e.split("/"),[t,c]=o.map(Number);return t/c},vo={displayEdgeLabels:!0,edgeLabelsEditable:!0,edgeInputToLabel:e=>{var c;const o=e.trim();if(!o)return;const t=(c=fo(o))==null?void 0:c.toFixed(2);return t==="Infinity"?"∞":t==="-Infinity"?"-∞":t===void 0&&isNaN(Number(o))?void 0:t??o},newNodeLabelGetter:null,isGraphDirected:!0},ho={focusable:!0,focusBlacklist:[]},go={draggable:!0},mo={nodeAnchors:!0},bo={marquee:!0,marqueeSelectableGraphTypes:["node","edge"]},po={interactive:!0,userAddedEdgeLabel:"1",userAddedEdgeRuleNoSelfLoops:!1,userAddedEdgeRuleOneEdgePerPath:!1},yo={persistent:!0,persistentStorageKey:"graph",persistentBlacklist:new Set},So={shortcuts:!0,shortcutUndo:!0,shortcutRedo:!0,shortcutSelectAll:!0,shortcutDelete:!0,shortcutEscape:!0},Eo={...vo,...ho,...go,...mo,...bo,...po,...yo,...So},ae=(e,...o)=>typeof e=="function"?e(...o):e,To=(e,o)=>(t,...c)=>{const r=o[t].findLast(u=>{const i=u.value;return ae(i,...c)!==void 0}),n=(r==null?void 0:r.value)??Se[e.value][t];if(!n)throw new Error(`Theme property "${t}" not found`);return ae(n,...c)},Co=(e,o)=>{const t=D(()=>{const r=new Map;for(const n of e.value)r.set(n.id,n);return r}),c=D(()=>{const r=new Map;for(const n of o.value)r.set(n.id,n);return r});return{nodeIdToNodeMap:t,edgeIdToEdgeMap:c}},Ao=({canvas:e,emit:o})=>{const t=B([]),c=[],r=()=>{var s,a,m,x;if(!e.value)return;const i=e.value.getContext("2d");if(!i)return;i.clearRect(0,0,e.value.width,e.value.height);const d=c.reduce((E,h)=>h(E),[]);t.value=[...d.sort((E,h)=>E.priority-h.priority)];const l=t.value.findLastIndex(E=>E.graphType==="edge"),b=t.value.slice(0,l+1),C=t.value.slice(l+1);for(const E of b)E.shape.drawShape(i);for(const E of b)(a=(s=E.shape).drawTextAreaMatte)==null||a.call(s,i);for(const E of b)(x=(m=E.shape).drawText)==null||x.call(m,i);for(const E of C)E.shape.draw(i);o("onRepaint",i,"loop")},n=setInterval(r,1e3/60);return he(()=>{clearInterval(n)}),setTimeout(r,1e3),{aggregator:t,updateAggregator:c,getSchemaItemsByCoordinates:i=>t.value.sort((d,l)=>d.priority-l.priority).filter(d=>{var l,b;return d.shape.shapeHitbox(i)||((b=(l=d.shape).textHitbox)==null?void 0:b.call(l,i))})}},No={broadcast:!0,focus:!0,history:!0},xo={broadcast:!0,focus:!1,history:!0},ce={broadcast:!0,history:!0},Z={broadcast:!0,focus:!1,history:!0},ie={broadcast:!0,history:!0},wo={broadcast:!0},Io={label:""},Bo="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");Array.from({length:999},(e,o)=>(o+1).toString());const Do=(e,o)=>()=>{let t=e.value.map(({label:i})=>i),c=0,r=0,n;const u=()=>c===0?"":o[(c-1)%o.length];for(;!n;){r>=o.length&&(t=t.slice(o.length),r=0,c++);const d=u()+o[r];t.includes(d)||(n=d),r++}return n},Mo=e=>Do(e.nodes,Bo),Ro=({nodes:e,edges:o,nodeMap:t,edgeMap:c,emit:r,settings:n})=>{const u=v=>t.value.get(v),i=v=>c.value.get(v),d=(v,p={})=>{if(v!=null&&v.id&&u(v.id)){console.warn("prevented adding a node with an existing id, this shouldn't happen");return}const f={...No,...p},g=n.value.newNodeLabelGetter??Mo({nodes:e}),T={id:v.id??V(),label:v.label??g(),x:v.x??0,y:v.y??0};return e.value.push(T),r("onNodeAdded",T,f),r("onStructureChange"),T},l=(v,p={})=>{if(v.length===0)return;const f={...xo,...p},g=[];for(const T of v){const I=d(T,{focus:!1,broadcast:!1,history:!1});I&&g.push(I)}g.length!==0&&r("onBulkNodeAdded",g,f)},b=(v,p={})=>{const f={...Z,...p},{isGraphDirected:g}=n.value,[T,I]=[u(v.from),u(v.to)];if(!T||!I)return;if(g){if(o.value.find(w=>w.from===v.from&&w.to===v.to))return}else if(o.value.find(w=>w.from===v.from&&w.to===v.to||w.from===v.to&&w.to===v.from))return;const y={...Io,id:V(),...v};return o.value.push(y),r("onEdgeAdded",y,f),r("onStructureChange"),y},C=(v,p={})=>{if(v.length===0)return;const f={...Z,...p},g=[];for(const T of v){const I=b(T,{broadcast:!1,history:!1});I&&g.push(I)}g.length!==0&&r("onBulkEdgeAdded",g,f)},s=(v,p,f={})=>{const g=u(v);if(!g)return;const T={...wo,...f};g.x=p.x,g.y=p.y,r("onNodeMoved",g,T)},a=(v,p,f={})=>{const g={...Z,...f},T=i(v);if(!T)return;const I=T.label;T.label=p,r("onEdgeLabelEdited",T,I,g),r("onStructureChange")},m=(v,p={})=>{const f=u(v);if(!f)return;const g={...ce,...p},I=fe(f.id,{edges:o,getEdge:i,settings:n}).map(y=>E(y.id,{broadcast:!1,history:!1})).filter(Boolean);return e.value=e.value.filter(y=>y.id!==f.id),r("onNodeRemoved",f,I,g),r("onStructureChange"),[f,I]},x=(v,p={})=>{if(v.length===0)return;const f={...ce,...p},g=[],T=[];for(const I of v){const y=m(I,{broadcast:!1,history:!1});if(!y)continue;const[A,w]=y;g.push(A),T.push(...w)}g.length!==0&&r("onBulkNodeRemoved",g,T,f)},E=(v,p={})=>{const f=i(v);if(!f)return;const g={...ie,...p};return o.value=o.value.filter(T=>T.id!==f.id),r("onEdgeRemoved",f,g),r("onStructureChange"),f};return{getNode:u,getEdge:i,addNode:d,addEdge:b,moveNode:s,editEdgeLabel:a,removeNode:m,removeEdge:E,bulkAddNode:l,bulkRemoveNode:x,bulkAddEdge:C,bulkRemoveEdge:(v,p={})=>{if(v.length===0)return;const f={...ie,...p},g=[];for(const T of v){const I=E(T,{broadcast:!1,history:!1});I&&g.push(I)}if(g.length!==0)return r("onBulkEdgeRemoved",g,f),g}}},_o=({subscribe:e,canvas:o,graphAtMousePosition:t})=>{const c=B(!1),r=B(!1),n=B({node:"grab",edge:"pointer","node-anchor":"grab","encapsulated-node-box":"move"}),u=B(),i=D(()=>!!u.value),d=s=>{u.value=s},l=()=>{u.value=void 0},b=s=>{var m;if(!s)return"default";if(i.value)return((m=u.value)==null?void 0:m.call(u,s))??!1?"pointer":"default";const a=n.value[s.graphType]??"default";return a==="grab"&&c.value?"grabbing":a},C=({items:s})=>{if(!o.value||r.value)return;const a=s.at(-1);o.value.style.cursor=b(a)};return e("onMouseDown",s=>{c.value=!0,C(s)}),e("onMouseUp",s=>{c.value=!1,C(s)}),e("onMouseMove",C),K(n,()=>{C({items:t.value.items})},{deep:!0}),{graphToCursorMap:n,activateCursorSelectMode:d,deactivateCursorSelectMode:l,graphCursorDisabled:r}},ko=(e,o={})=>{const t=B("light"),c=ao(),r=To(t,c),n=B({...Eo,...o}),u=uo(),{subscribe:i,unsubscribe:d,emit:l}=io(u),b=B(!0);Oe(e,()=>{b.value=!1}),i("onMouseDown",()=>{b.value=!0});const C=B([]),s=B([]),a=B({coords:{x:0,y:0},items:[]}),m=_o({canvas:e,subscribe:i,graphAtMousePosition:a}),x=N=>{const M=ye(e),F=Ge(N,M);a.value={coords:F,items:g(F)}},E=N=>({...a.value,event:N}),h={click:N=>{N.preventDefault(),l("onClick",E(N))},mousemove:N=>{N.preventDefault(),l("onMouseMove",E(N))},mousedown:N=>{N.preventDefault(),l("onMouseDown",E(N))},mouseup:N=>{N.preventDefault(),l("onMouseUp",E(N))},dblclick:N=>{N.preventDefault(),l("onDblClick",E(N))},contextmenu:N=>{l("onContextMenu",E(N))}},v={keydown:N=>l("onKeyDown",N),keyup:N=>l("onKeyUp",N)},{aggregator:p,updateAggregator:f,getSchemaItemsByCoordinates:g}=Ao({canvas:e,emit:l}),T=N=>{const M={edges:s,getNode:A,getEdge:w,getTheme:r,settings:n},F=s.value.map(W=>oo(W,M)).filter(Boolean).map((W,J)=>({...W,priority:J*10})),Ne=C.value.map(W=>$e(W,r)).filter(Boolean).map((W,J)=>({...W,priority:J*10+1e3}));return N.push(...F),N.push(...Ne),N};f.push(T),Pe(()=>{if(!e.value)throw new Error("canvas element not found");e.value.addEventListener("mousemove",x);for(const[N,M]of Object.entries(h))e.value.addEventListener(N,M);for(const[N,M]of Object.entries(v))document.addEventListener(N,M)}),Ue(()=>{if(!e.value)throw new Error("Canvas element not found");e.value.removeEventListener("mousemove",x);for(const[N,M]of Object.entries(h))e.value.removeEventListener(N,M);for(const[N,M]of Object.entries(v))document.removeEventListener(N,M)});const{nodeIdToNodeMap:I,edgeIdToEdgeMap:y}=Co(C,s),{getNode:A,getEdge:w,addNode:_,addEdge:R,moveNode:k,editEdgeLabel:U,removeNode:O,removeEdge:H,bulkAddNode:z,bulkRemoveNode:oe,bulkAddEdge:L,bulkRemoveEdge:G}=Ro({nodes:C,edges:s,nodeMap:I,edgeMap:y,emit:l,settings:n}),q=(N,M)=>{const F=g({x:N,y:M}).pop();if(F&&F.graphType==="node")return A(F.id)};let P;i("onMouseMove",({items:N})=>{const M=N.at(-1);if(!M||M.graphType!=="node")return;const F=A(M.id);F!==P&&(l("onNodeHoverChange",F,P),P=F)});const Te=N=>(P&&ge(P.id,N),N);f.push(Te);const Ce=N=>{C.value=N.nodes,s.value=N.edges,l("onGraphLoaded"),l("onStructureChange")},Ae=()=>{C.value=[],s.value=[],l("onGraphReset"),l("onStructureChange")};K(t,async(N,M)=>{l("onThemeChange",N,M)});const te=B($(n.value));return K(n,N=>{const M=Ee(te.value,N);M&&(te.value=$(n.value),l("onSettingsChange",M))},{deep:!0}),{nodes:C,edges:s,getNode:A,getEdge:w,addNode:_,addEdge:R,moveNode:k,editEdgeLabel:U,removeNode:O,removeEdge:H,bulkAddNode:z,bulkRemoveNode:oe,bulkAddEdge:L,bulkRemoveEdge:G,getSchemaItemsByCoordinates:g,getNodeByCoordinates:q,eventBus:u,subscribe:i,unsubscribe:d,emit:l,updateAggregator:f,aggregator:p,baseTheme:D(()=>Se[t.value]),themeName:t,getTheme:r,themeMap:c,settings:n,load:Ce,reset:Ae,canvas:e,canvasFocused:b,graphAtMousePosition:a,updateGraphAtMousePosition:x,...m}},Lo="use-marquee-graph",Fo={THEME_ID:Lo},Oo=e=>{const o=B(),t=B(),c=B(),{setTheme:r,removeTheme:n}=me(e,Fo.THEME_ID),u=()=>r("nodeAnchorColor",S.TRANSPARENT),i=()=>n("nodeAnchorColor"),d=y=>{const{width:A,height:w}=y;return Math.abs(A*w)},l=({items:y,coords:A})=>{const w=y.at(-1);(w==null?void 0:w.graphType)!=="encapsulated-node-box"&&i(),w||a(A)},b=({items:y,coords:A})=>{if(!c.value)return;const w=y.at(-1);if((w==null?void 0:w.graphType)!=="encapsulated-node-box")return;const _=A.x-c.value.x,R=A.y-c.value.y;c.value=A;for(const k of e.focusedNodes.value)e.moveNode(k.id,{x:k.x+_,y:k.y+R});E()},C=({items:y,coords:A})=>{if(o.value)return;const w=y.at(-1);(w==null?void 0:w.graphType)==="encapsulated-node-box"&&(c.value=A,e.emit("onGroupDragStart",e.focusedNodes.value,A))},s=()=>{c.value&&(e.emit("onGroupDrop",e.focusedNodes.value,c.value),c.value=void 0)},a=y=>{u(),e.graphCursorDisabled.value=!0,o.value={at:y,width:0,height:0}},m=()=>{o.value&&(o.value=void 0,e.graphCursorDisabled.value=!1,i())},x=y=>{if(d(y)<100)return;const w=[];for(const{id:_,shape:R,graphType:k}of e.aggregator.value){const{marqueeSelectableGraphTypes:U}=e.settings.value;if(!U.includes(k))continue;R.efficientHitbox(y)&&w.push(_)}e.setFocus(w)},E=()=>{if(t.value={at:{x:1/0,y:1/0},width:0,height:0},e.focusedNodes.value.length<2)return;let y=1/0,A=1/0,w=-1/0,_=-1/0;for(const R of e.focusedNodes.value){const k=e.getTheme("nodeSize",R),U=e.getTheme("nodeBorderWidth",R),O=k+U/2,{x:H,y:z}=R;y=Math.min(y,H-O),A=Math.min(A,z-O),w=Math.max(w,H+O),_=Math.max(_,z+O)}y<1/0&&A<1/0&&w>-1/0&&_>-1/0?(t.value.at.x=y,t.value.at.y=A,t.value.width=w-y,t.value.height=_-A):(t.value.width=0,t.value.height=0)},h=({coords:y})=>{if(!o.value)return;const{x:A,y:w}=y;o.value.width=A-o.value.at.x,o.value.height=w-o.value.at.y,x(o.value)},v=y=>({id:"marquee-box",graphType:"marquee-box",shape:ne({...y,color:e.getTheme("marqueeSelectionBoxColor"),stroke:{color:e.getTheme("marqueeSelectionBoxBorderColor"),width:2}}),priority:1/0}),p=y=>{if(!o.value)return y;const A=v(o.value);return y.push(A),y},f=y=>({id:"encapsulated-node-box",graphType:"encapsulated-node-box",shape:ne({...y,color:e.getTheme("marqueeEncapsulatedNodeBoxColor"),stroke:{color:e.getTheme("marqueeEncapsulatedNodeBoxBorderColor"),width:2}}),priority:1/0}),g=y=>{if(!t.value)return y;const A=f(t.value);return y.push(A),y};e.updateAggregator.push(g),e.updateAggregator.push(p);const T=()=>{e.subscribe("onFocusChange",E),e.subscribe("onMouseDown",l),e.subscribe("onMouseUp",m),e.subscribe("onContextMenu",m),e.subscribe("onMouseMove",h),e.subscribe("onMouseDown",C),e.subscribe("onMouseUp",s),e.subscribe("onMouseMove",b),e.subscribe("onUndo",E),e.subscribe("onRedo",E)},I=()=>{e.unsubscribe("onFocusChange",E),e.unsubscribe("onMouseDown",l),e.unsubscribe("onMouseUp",m),e.unsubscribe("onContextMenu",m),e.unsubscribe("onMouseMove",h),e.unsubscribe("onMouseDown",C),e.unsubscribe("onMouseUp",s),e.unsubscribe("onMouseMove",b),e.unsubscribe("onUndo",E),e.unsubscribe("onRedo",E),o.value&&m()};return e.subscribe("onSettingsChange",y=>{y.marquee===!0?T():y.marquee===!1&&I()}),e.settings.value.marquee&&T(),{updateEncapsulatedNodeBox:E}},Po=e=>{const o=B(),t=({items:i,coords:d})=>{const l=i.at(-1);if(!l||l.graphType!=="node")return;e.settings.value.nodeAnchors=!1;const b=e.getNode(l.id);b&&(o.value={node:b,coords:d},e.emit("onNodeDragStart",b))},c=()=>{o.value&&(e.emit("onNodeDrop",o.value.node),e.settings.value.nodeAnchors=!0,e.nodeAnchorSetParentNode(o.value.node.id),o.value=void 0)},r=({coords:i})=>{if(!o.value)return;const{node:d,coords:l}=o.value,b=i.x-l.x,C=i.y-l.y;e.moveNode(d.id,{x:d.x+b,y:d.y+C}),o.value.coords=i},n=()=>{e.subscribe("onMouseDown",t),e.subscribe("onMouseUp",c),e.subscribe("onMouseMove",r)},u=()=>{e.unsubscribe("onMouseDown",t),e.unsubscribe("onMouseUp",c),e.unsubscribe("onMouseMove",r),o.value&&c()};return e.subscribe("onSettingsChange",i=>{i.draggable===!1?u():i.draggable===!0&&n()}),e.settings.value.draggable&&n(),{activeDragNode:D(()=>{var i;return(i=o.value)==null?void 0:i.node})}},Uo=e=>{const o=B(),t=B(),c=f=>{const g=e.getNode(f);if(!g)throw new Error("node not found");o.value=g,i(g)},r=()=>{o.value=void 0,t.value=void 0},n=f=>{const{getTheme:g}=e,T=g("nodeAnchorColor",f),I=g("nodeAnchorRadius",f),y=[];for(const A of u.value){const{x:w,y:_}=A,R={at:{x:w,y:_},radius:I,color:T};t.value&&t.value.direction===A.direction&&(R.at.x=t.value.x,R.at.y=t.value.y);const k=be(R);y.push({id:A.id,graphType:"node-anchor",shape:k,priority:1/0})}return y},u=B([]),i=f=>{if(!f)return u.value=[];const{getTheme:g}=e,T=g("nodeAnchorRadius",f),I=g("nodeSize",f),y=g("nodeBorderWidth",f),A=I-T/3+y/2;u.value=[{x:f.x,y:f.y-A,direction:"north"},{x:f.x+A,y:f.y,direction:"east"},{x:f.x,y:f.y+A,direction:"south"},{x:f.x-A,y:f.y,direction:"west"}].map(w=>({...w,id:V()}))},d=({items:f})=>{const g=f.at(-1);if(!g||g.graphType!=="node-anchor")return;const{id:T}=g;return u.value.find(I=>I.id===T)},l=()=>{if(!o.value||!t.value)return;const{x:f,y:g}=t.value,T={x:o.value.x,y:o.value.y},I={x:f,y:g},{getTheme:y}=e,A=y("linkPreviewColor",o.value,t.value),w=y("linkPreviewWidth",o.value,t.value);return{id:"link-preview",graphType:"link-preview",shape:pe({start:T,end:I,color:A,width:w})}},b=({items:f})=>{if(t.value)return;const g=f.at(-1);if(!g)return r();if(g.graphType!=="node")return;const T=e.getNode(g.id);if(!T)throw new Error("node in aggregator but not in graph");const I=e.isFocused(T.id),y=e.focusedNodes.value.length>1;if(I&&y)return r();o.value=T,i(T)},C=f=>{if(!o.value)return;const g=d(f);g&&(t.value=g,e.emit("onNodeAnchorDragStart",o.value,g))},s=({coords:f})=>{if(!t.value)return;const{x:g,y:T}=f;t.value.x=g,t.value.y=T},a=()=>{if(t.value){if(!o.value)throw new Error("active anchor without parent node")}else return;e.emit("onNodeAnchorDrop",o.value,t.value),r()},m=f=>{if(!o.value)return f;const g=n(o.value);for(const T of g)f.push(T);return f},x=f=>{var A;if(!o.value||!t.value)return f;const{id:g}=o.value;ge(g,f);const T=(A=f.find(w=>w.id===g))==null?void 0:A.priority;if(!T)return f;const I=l();if(!I)return f;const y={...I,priority:T-.1};return f.push(y),f};e.updateAggregator.push(m),e.updateAggregator.push(x);const E=f=>{var g;((g=o.value)==null?void 0:g.id)===f.id&&r()},h=()=>{if(!o.value)return;const f=e.isFocused(o.value.id),g=e.focusedNodes.value.length>1;f&&g&&r()},v=()=>{e.subscribe("onNodeRemoved",E),e.subscribe("onNodeMoved",r),e.subscribe("onNodeDrop",i),e.subscribe("onMouseMove",b),e.subscribe("onMouseMove",s),e.subscribe("onMouseDown",C),e.subscribe("onMouseUp",a),e.subscribe("onFocusChange",h)},p=()=>{e.unsubscribe("onNodeRemoved",E),e.unsubscribe("onNodeMoved",r),e.unsubscribe("onNodeDrop",i),e.unsubscribe("onMouseMove",b),e.unsubscribe("onMouseMove",s),e.unsubscribe("onMouseDown",C),e.unsubscribe("onMouseUp",a),e.unsubscribe("onFocusChange",h),r()};return e.subscribe("onSettingsChange",f=>{f.nodeAnchors===!0?v():f.nodeAnchors===!1&&p()}),e.settings.value.nodeAnchors&&v(),{nodeAnchorActiveAnchor:Q(t),nodeAnchorParentNode:Q(o),nodeAnchorSetParentNode:c}},Go=(e=!1)=>{const o=i=>i.key===" "?"Space":i.key.length>1||e?i.key:i.key.toUpperCase(),t=B(""),c=D(()=>{let i;return t.value.split("+").filter(d=>{const l=d===i;return i=d,!l}).join("+")}),r=i=>{t.value.length>0&&(t.value+="+"),t.value+=o(i)},n=()=>{t.value=""},u=i=>c.value===i;return document.addEventListener("keydown",r),document.addEventListener("keyup",n),he(()=>{document.removeEventListener("keydown",r),document.removeEventListener("keyup",n)}),{isPressed:u,currentKeyString:t}},Wo=window.navigator.userAgent.includes("Mac")?"Mac":"Windows",Ho=e=>{const{settings:o}=e,t=()=>{e.annotationActive.value&&e.undoAnnotation(),o.value.interactive&&e.undo()},c=()=>{e.annotationActive.value&&e.redoAnnotation(),o.value.interactive&&e.redo()},r=()=>e.resetFocus(),n=()=>e.focusAll(),u=()=>{o.value.interactive!==!1&&(e.bulkRemoveNode([...e.focusedItemIds.value]),e.bulkRemoveEdge([...e.focusedItemIds.value]))},i=(v,p)=>p===!1?()=>{}:typeof p=="function"?p:v,d=D(()=>i(c,o.value.shortcutRedo)),l=D(()=>i(t,o.value.shortcutUndo)),b=D(()=>i(r,o.value.shortcutEscape)),C=D(()=>i(n,o.value.shortcutSelectAll)),s=D(()=>i(u,o.value.shortcutDelete)),a=D(()=>({Mac:{"Meta+Z":l.value,"Shift+Meta+Z":d.value,"Meta+Shift+Z":d.value,Backspace:s.value,"Meta+A":C.value,Escape:b.value},Windows:{"Control+Z":l.value,"Shift+Control+Z":d.value,"Control+Shift+Z":d.value,Backspace:s.value,"Control+A":C.value,Escape:b.value}})),{isPressed:m}=Go(),x=v=>{if(e.canvasFocused.value===!1)return;const p=a.value[Wo];for(const f in p)if(m(f)){p[f](),v.preventDefault();return}},E=()=>{e.subscribe("onKeyDown",x)},h=()=>{e.unsubscribe("onKeyDown",x)};return o.value.shortcuts&&E(),e.subscribe("onSettingsChange",v=>{v.shortcuts===!0?E():v.shortcuts===!1&&h()}),{delete:s,selectAll:C,escape:b,redo:d,undo:l}},qo=[S.RED_600,S.BLUE_600,S.GREEN_600,S.YELLOW_600],Ko=[3,6,9,12],ue=100,zo=e=>{const o=B([]),t=B([]);return{clearHistory:()=>{o.value=[],t.value=[]},undo:()=>{const d=o.value.pop();if(!d)return;const{action:l,annotations:b}=d,C=b.map(({id:s})=>s);l==="add"?e.value=e.value.filter(({id:s})=>!C.includes(s)):l==="remove"&&e.value.push(...b),t.value.push(d)},redo:()=>{const d=t.value.pop();if(!d)return;const{action:l,annotations:b}=d,C=b.map(({id:s})=>s);l==="add"?e.value.push(...b):l==="remove"&&(e.value=e.value.filter(({id:s})=>!C.includes(s))),o.value.push(d)},addToUndoStack:d=>{o.value.push(d),o.value.length>ue&&o.value.shift()},addToRedoStack:d=>{t.value.push(d),t.value.length>ue&&t.value.shift()},canUndo:D(()=>o.value.length!==0),canRedo:D(()=>t.value.length!==0)}},jo=e=>{const o=B(qo[0]),t=B(Ko[1]),c=B(!1),r=B(new Set),n=B([]),u=B([]),i=B(!1),d=B(),l=B(!1),b=zo(u),C=()=>{u.value.length!==0&&(b.addToUndoStack({action:"remove",annotations:u.value}),u.value=[])},s=({coords:v})=>{i.value=!0,d.value=v,n.value=[v]},a=({coords:v})=>{if(!(!i.value||!d.value)){if(c.value){const p=u.value.filter(f=>Y.scribble(f).hitbox(v));for(const f of p)r.value.add(f.id);return}d.value=v,n.value.push(v)}},m=()=>{if(!i.value||(i.value=!1,d.value=void 0,n.value.length===0))return;if(c.value){const p=u.value.filter(f=>r.value.has(f.id));b.addToUndoStack({action:"remove",annotations:p}),u.value=u.value.filter(f=>!r.value.has(f.id)),r.value.clear();return}const v={id:V(),type:"draw",points:n.value,color:o.value,brushWeight:t.value};u.value.push(v),b.addToUndoStack({action:"add",annotations:[v]}),n.value=[]};K(c,()=>{e.canvas.value&&(e.canvas.value.style.cursor=c.value?"none":"crosshair")});const x=v=>{if(!l.value)return v;if(c.value){const p=Y.circle({at:e.graphAtMousePosition.value.coords,radius:10,color:S.TRANSPARENT,stroke:{color:S.WHITE+"60",width:2}});v.push({graphType:"annotation",id:p.id,shape:p,priority:5050})}else if(n.value.length>0){const p=Y.scribble({type:"draw",points:n.value,color:o.value,brushWeight:t.value});v.push({graphType:"annotation",id:p.id,shape:p,priority:5001})}for(const p of u.value){const f=r.value.has(p.id);v.push({graphType:"annotation",id:p.id,shape:Y.scribble({...p,color:p.color+(f?"50":"")}),priority:5e3})}return v};return e.updateAggregator.push(x),{clearAnnotations:C,annotationActive:l,annotationErasing:c,annotationColor:o,annotationBrushWeight:t,activateAnnotation:()=>{e.canvas.value&&(l.value=!0,e.settings.value.interactive=!1,e.settings.value.marquee=!1,e.settings.value.focusable=!1,e.settings.value.draggable=!1,e.graphCursorDisabled.value=!0,e.canvas.value.style.cursor="crosshair",e.subscribe("onMouseDown",s),e.subscribe("onMouseMove",a),e.subscribe("onMouseUp",m))},deactivateAnnotation:()=>{e.canvas.value&&(l.value=!1,c.value=!1,e.settings.value.interactive=!0,e.settings.value.marquee=!0,e.settings.value.focusable=!0,e.settings.value.draggable=!0,e.graphCursorDisabled.value=!1,e.canvas.value.style.cursor="default",e.unsubscribe("onMouseDown",s),e.unsubscribe("onMouseMove",a),e.unsubscribe("onMouseUp",m))},undoAnnotation:b.undo,redoAnnotation:b.redo,canUndoAnnotation:b.canUndo,canRedoAnnotation:b.canRedo}},Yo=["node","edge"],Vo="use-focus-graph",Jo=e=>{const{setTheme:o}=me(e,Vo),t=B(new Set),c=B(!1),r=h=>{const v=h.filter(T=>!e.settings.value.focusBlacklist.includes(T));if(v.length===t.value.size&&v.every(T=>t.value.has(T)))return;const g=new Set([...t.value]);t.value=new Set(v),e.emit("onFocusChange",t.value,g)},n=h=>{if(t.value.has(h)||e.settings.value.focusBlacklist.includes(h))return;const f=new Set([...t.value]);t.value.add(h),e.emit("onFocusChange",t.value,f)},u=h=>{var p,f;const v=ye(e.canvas);(f=(p=h.shape).activateTextArea)==null||f.call(p,v,g=>{const T=e.getEdge(h.id);if(!T)throw new Error("textarea only implemented for edges");const I=e.settings.value.edgeInputToLabel(g);I===void 0||T.label===I||e.editEdgeLabel(T.id,I)})},i=()=>{const h=Array.from(t.value),v=h.filter(p=>e.getNode(p)||e.getEdge(p));v.length!==h.length&&r(v)},d=({items:h,coords:v})=>{var I,y;const p=h.at(-1);if(!p)return c.value?void 0:l();if(((y=(I=p.shape).textHitbox)==null?void 0:y.call(I,v))&&e.settings.value.edgeLabelsEditable&&p.graphType==="edge")return l(),u(p);Yo.some(A=>A===p.graphType)&&(c.value?n(p.id):r([p.id]))},l=()=>r([]),b=()=>{const h=e.nodes.value.map(p=>p.id),v=e.edges.value.map(p=>p.id);r([...h,...v])},C=({id:h},{focus:v})=>{v&&r([h])},s=h=>t.value.has(h);o("nodeColor",h=>{if(s(h.id))return e.getTheme("nodeFocusColor",h)}),o("nodeBorderColor",h=>{if(s(h.id))return e.getTheme("nodeFocusBorderColor",h)}),o("nodeTextColor",h=>{if(s(h.id))return e.getTheme("nodeFocusTextColor",h)}),o("edgeColor",h=>{if(s(h.id))return e.getTheme("edgeFocusColor",h)}),o("edgeTextColor",h=>{if(s(h.id))return e.getTheme("edgeFocusTextColor",h)}),o("nodeAnchorColor",h=>{if(s(h.id))return e.getTheme("nodeAnchorColorWhenParentFocused",h)});const a=h=>{h.key==="Shift"&&(c.value=!0)},m=h=>{h.key==="Shift"&&(c.value=!1)},x=()=>{e.subscribe("onNodeAdded",C),e.subscribe("onEdgeAdded",C),e.subscribe("onMouseDown",d),e.subscribe("onKeyDown",a),e.subscribe("onKeyUp",m),e.subscribe("onStructureChange",i)},E=()=>{e.unsubscribe("onNodeAdded",C),e.unsubscribe("onEdgeAdded",C),e.unsubscribe("onMouseDown",d),e.unsubscribe("onKeyDown",a),e.unsubscribe("onKeyUp",m),e.unsubscribe("onStructureChange",i),l()};return e.subscribe("onSettingsChange",h=>{h.focusable===!1?E():h.focusable===!0&&x()}),e.settings.value.focusable&&x(),{focusedItemIds:Q(t),setFocus:r,resetFocus:l,addToFocus:n,isFocused:s,focusAll:b,focusedNodes:D(()=>e.nodes.value.filter(h=>s(h.id))),focusedEdges:D(()=>e.edges.value.filter(h=>s(h.id)))}},Zo={focus:!0},Xo={focus:!0},de=100,le=3,Qo=e=>{const o=B([]),t=B([]),c=s=>{o.value.push(s),o.value.length>de&&o.value.shift()},r=s=>{t.value.push(s),t.value.length>de&&t.value.shift()};e.subscribe("onNodeAdded",(s,{history:a})=>{a&&c({action:"add",affectedItems:[{graphType:"node",data:s}]})}),e.subscribe("onBulkNodeAdded",(s,{history:a})=>{a&&c({action:"add",affectedItems:s.map(m=>({graphType:"node",data:m}))})}),e.subscribe("onNodeRemoved",(s,a,{history:m})=>{if(!m)return;const x=a.map(E=>({graphType:"edge",data:E}));c({action:"remove",affectedItems:[{graphType:"node",data:s},...x]})}),e.subscribe("onBulkNodeRemoved",(s,a,{history:m})=>{if(!m)return;const x=s.map(h=>({graphType:"node",data:h})),E=a.map(h=>({graphType:"edge",data:h}));c({action:"remove",affectedItems:[...x,...E]})}),e.subscribe("onEdgeLabelEdited",(s,a,{history:m})=>{m&&c({action:"edit",affectedItems:[{graphType:"edge",data:{id:s.id,from:a,to:s.label}}]})}),e.subscribe("onEdgeAdded",(s,{history:a})=>{a&&c({action:"add",affectedItems:[{graphType:"edge",data:s}]})}),e.subscribe("onBulkEdgeAdded",(s,{history:a})=>{a&&c({action:"add",affectedItems:s.map(m=>({graphType:"edge",data:m}))})}),e.subscribe("onEdgeRemoved",(s,{history:a})=>{a&&c({action:"remove",affectedItems:[{graphType:"edge",data:s}]})}),e.subscribe("onBulkEdgeRemoved",(s,{history:a})=>{a&&c({action:"remove",affectedItems:s.map(m=>({graphType:"edge",data:m}))})});const n=B();e.subscribe("onGroupDragStart",(s,a)=>{n.value={startingCoordinates:a,nodes:s}}),e.subscribe("onGroupDrop",(s,a)=>{if(!n.value)throw new Error("dropped a group we didn't know was being dragged");if(n.value.nodes.length!==s.length)throw new Error("group size mismatch");const m=n.value.startingCoordinates.y-a.y,x=n.value.startingCoordinates.x-a.x;Math.sqrt(m**2+x**2)<le||c({action:"move",affectedItems:n.value.nodes.map(h=>({graphType:"node",data:{id:h.id,from:{x:h.x+x,y:h.y+m},to:{x:h.x,y:h.y}}}))})});const u=B();e.subscribe("onNodeDragStart",s=>{u.value={id:s.id,from:{x:s.x,y:s.y},to:{x:s.x,y:s.y}}}),e.subscribe("onNodeDrop",s=>{if(!u.value)throw new Error("dropped a node we didn't know was being dragged");if(u.value.id!==s.id)throw new Error("node ID mismatch");u.value.to={x:s.x,y:s.y};const a=u.value.from.y-u.value.to.y,m=u.value.from.x-u.value.to.x;Math.sqrt(a**2+m**2)<le||c({action:"move",affectedItems:[{graphType:"node",data:u.value}]})});const i=(s={})=>{const a=o.value.pop();if(a)return r(a),l(a),e.emit("onUndo",a,{...Zo,...s}),a},d=(s={})=>{const a=t.value.pop();if(a)return c(a),b(a),e.emit("onRedo",a,{...Xo,...s}),a},l=s=>{if(s.action==="add")for(const a of s.affectedItems)a.graphType==="node"?e.removeNode(a.data.id,{history:!1}):a.graphType==="edge"&&e.removeEdge(a.data.id,{history:!1});else if(s.action==="remove")for(const a of s.affectedItems)a.graphType==="node"?e.addNode(a.data,{history:!1,focus:!1}):a.graphType==="edge"&&e.addEdge(a.data,{history:!1,focus:!1});else if(s.action==="move"){for(const a of s.affectedItems)if(a.graphType==="node"){const{from:m,id:x}=a.data;e.moveNode(x,{x:m.x,y:m.y})}}else if(s.action==="edit")for(const a of s.affectedItems)e.editEdgeLabel(a.data.id,a.data.from,{history:!1})},b=s=>{if(s.action==="add")for(const a of s.affectedItems)a.graphType==="node"?e.addNode(a.data,{history:!1,focus:!1}):a.graphType==="edge"&&e.addEdge(a.data,{history:!1,focus:!1});else if(s.action==="remove")for(const a of s.affectedItems)a.graphType==="node"?e.removeNode(a.data.id,{history:!1}):a.graphType==="edge"&&e.removeEdge(a.data.id,{history:!1});else if(s.action==="move"){for(const a of s.affectedItems)if(a.graphType==="node"){const{to:m,id:x}=a.data;e.moveNode(x,{x:m.x,y:m.y})}}else if(s.action==="edit")for(const a of s.affectedItems)e.editEdgeLabel(a.data.id,a.data.to,{history:!1})},C=()=>{o.value=[],t.value=[]};return{undo:i,redo:d,canUndo:D(()=>o.value.length>0),canRedo:D(()=>t.value.length>0),undoStack:o,redoStack:t,addToUndoStack:c,addToRedoStack:r,clearHistory:C}},$o=e=>{const o={get:()=>JSON.parse(localStorage.getItem(e.settings.value.persistentStorageKey+"-nodes")??"[]"),set:d=>{const l=d.filter(b=>!e.settings.value.persistentBlacklist.has(b.id));localStorage.setItem(e.settings.value.persistentStorageKey+"-nodes",JSON.stringify(l))}},t={get:()=>JSON.parse(localStorage.getItem(e.settings.value.persistentStorageKey+"-edges")??"[]"),set:d=>{const l=d.filter(b=>!e.settings.value.persistentBlacklist.has(b.id));localStorage.setItem(e.settings.value.persistentStorageKey+"-edges",JSON.stringify(l))}},c=async()=>{await new Promise(d=>setTimeout(d,10)),o.set(e.nodes.value),t.set(e.edges.value)},r=()=>e.load({nodes:o.get(),edges:t.get()}),n=["onStructureChange","onNodeDrop","onGroupDrop"],u=()=>{n.forEach(d=>e.subscribe(d,c))},i=()=>{n.forEach(d=>e.unsubscribe(d,c))};return e.subscribe("onSettingsChange",d=>{if(i(),"persistent"in d&&!d.persistent)return;if("persistent"in d&&d.persistent){r(),u();return}"persistentStorageKey"in d&&r(),u()}),e.settings.value.persistent&&(queueMicrotask(r),u()),{trackGraphState:c}},et=e=>{const o=({coords:n,event:u})=>{e.addNode(n),setTimeout(()=>e.updateGraphAtMousePosition(u),10)},t=(n,u)=>{const d=e.getSchemaItemsByCoordinates(u).findLast(b=>b.graphType==="node");if(!d)return;const l=e.getNode(d.id);if(l&&!(e.settings.value.userAddedEdgeRuleNoSelfLoops&&n.id===l.id)){if(e.settings.value.userAddedEdgeRuleOneEdgePerPath){const b=e.edges.value.find(a=>a.from===n.id&&a.to===l.id),C=e.edges.value.find(a=>a.from===l.id&&a.to===n.id);if(b||C)return}e.addEdge({from:n.id,to:l.id,label:e.settings.value.userAddedEdgeLabel})}},c=()=>{e.subscribe("onDblClick",o),e.subscribe("onNodeAnchorDrop",t),e.settings.value.nodeAnchors=!0,e.settings.value.edgeLabelsEditable=!0},r=()=>{e.unsubscribe("onDblClick",o),e.unsubscribe("onNodeAnchorDrop",t),e.settings.value.nodeAnchors=!1,e.settings.value.edgeLabelsEditable=!1};e.settings.value.interactive&&c(),e.subscribe("onSettingsChange",n=>{n.interactive===!0?c():n.interactive===!1&&r()})},ot=({adjacencyList:e,undirectedAdjacencyList:o})=>{const t=(u,i)=>{const d=new Set,l=[];for(l.push(i);l.length>0;){const b=l.shift();if(!b)break;d.add(b),u[b].forEach(s=>{d.has(s)||l.push(s)})}return d},c=u=>Object.keys(u).every(i=>t(u,i).size===Object.keys(u).length),r=D(()=>c(e.value)),n=D(()=>c(o.value));return{isConnected:r,isWeaklyConnected:n}};class tt{constructor(o){j(this,"V");j(this,"adj");j(this,"Time");j(this,"SCCs",[]);this.V=o,this.adj=new Array(o).fill(0).map(()=>[]),this.Time=0}addEdge(o,t){this.adj[o].push(t)}SCCUtil(o,t,c,r,n){c[o]=this.Time,t[o]=this.Time,this.Time+=1,r[o]=!0,n.push(o);for(const u of this.adj[o])c[u]===-1?(this.SCCUtil(u,t,c,r,n),t[o]=Math.min(t[o],t[u])):r[u]&&(t[o]=Math.min(t[o],c[u]));if(t[o]===c[o]){let u;const i=[];do u=n.pop(),i.push(u),r[u]=!1;while(u!==o);this.SCCs.push(i)}}SCC(){const o=new Array(this.V).fill(-1),t=new Array(this.V).fill(-1),c=new Array(this.V).fill(!1),r=[];for(let n=0;n<this.V;n++)o[n]===-1&&this.SCCUtil(n,t,o,c,r);return this.SCCs}}const nt=(e,o)=>{const t=new tt(e.length),c=e.map(n=>n.id);for(const n of o)t.addEdge(c.indexOf(n.from),c.indexOf(n.to));return t.SCC().map(n=>n.map(u=>e[u]))},st=e=>{const o={},t=[[],[]],c={...e};Object.keys(e).forEach(u=>{c[u]||(c[u]=[])});const r={};Object.entries(c).forEach(([u,i])=>{i.forEach(d=>{r[d]||(r[d]=[]),r[d].push(u)})});const n=u=>{const i=[u];for(o[u]=0,t[0].push(u);i.length>0;){const d=i.shift(),l=o[d],b=l===0?1:0,C=c[d]||[],s=r[d]||[],a=[...new Set([...C,...s])];for(const m of a)if(o[m]===void 0)o[m]=b,t[b].push(m),i.push(m);else if(o[m]===l)return!1}return!0};for(const u of Object.keys(c))if(o[u]===void 0&&!n(u))return;return t},rt=e=>{const o=new Set,t=[],c=[],r=new Set,n=(i,d)=>{o.add(i),c.push(i),r.add(i);for(const l of e[i]||[])if(!o.has(l))n(l,i);else if(l!==d&&r.has(l)){const b=c.indexOf(l),s=[...c.slice(b)].sort();t.some(a=>u(a,s))||t.push(s)}c.pop(),r.delete(i)},u=(i,d)=>i.length!==d.length?!1:i.every(l=>d.includes(l));for(const i in e)o.has(i)||n(i,null);return t},at=e=>{const o=ot(e.adjacencyLists),t=D(()=>{const a=e.edges.value;return a.filter(m=>a.some(x=>m.from===x.to&&m.to===x.from))}),c=D(()=>nt(e.nodes.value,e.edges.value)),r=D(()=>c.value.reduce((m,x,E)=>{for(const{id:h}of x)m.set(h,E);return m},new Map)),n=D(()=>t.value.length>0),u=D(()=>{const a=e.adjacencyLists.adjacencyList.value;return st(a)}),i=D(()=>{const a=u.value,m=new Map;if(!a)return m;const[x,E]=a;for(const h of x)m.set(h,0);for(const h of E)m.set(h,1);return m}),d=D(()=>e.settings.value.isGraphDirected?c.value.filter(m=>m.length>1).map(m=>m.map(x=>x.id)):rt(e.adjacencyLists.adjacencyList.value).sort((x,E)=>x.length-E.length)),l=D(()=>d.value.reduce((a,m,x)=>{for(const E of m)a.set(E,x);return a},new Map)),b=D(()=>d.value.length===0),C=D(()=>{const a=e.settings.value.isGraphDirected,m=e.nodes.value.length;return e.edges.value.length===(a?m*(m-1):m*(m-1)/2)}),s=D(()=>!!u.value);return{bidirectionalEdges:t,hasBidirectionalEdges:n,stronglyConnectedComponents:c,nodeIdToStronglyConnectedComponent:r,bipartitePartition:u,nodeIdToBipartitePartition:i,isBipartite:s,cycles:d,nodeIdToCycle:l,isAcyclic:b,isComplete:C,...o}},lt=(e,o={})=>{const t=ko(e,o),c=Jo(t),r=Qo(t),n=Oo({...t,...c}),u=Uo({...t,...c}),i=Po({...t,...u}),d=jo(t),l=$o(t),b=Xe(t),C=Ho({...t,...r,...c,...d}),s=We(t),a=He(t),m=at({...t,adjacencyLists:s});return et(t),{...t,...c,...r,...n,...i,...u,...d,...l,...b,shortcutActions:C,adjacencyLists:s,transitionMatrix:a,characteristics:m,helpers:Qe(t)}},ft=qe({__name:"Graph",props:{graph:{}},emits:["graphRef"],setup(e,{emit:o}){const t=e,c=o,r=d=>c("graphRef",d),n=B(t.graph.getTheme("graphBgPatternColor")),u=B(t.graph.getTheme("graphBgColor")),i=async()=>{n.value=t.graph.getTheme("graphBgPatternColor"),u.value=t.graph.getTheme("graphBgColor")};return t.graph.subscribe("onThemeChange",i),(d,l)=>(ze(),Ke(Je,{onCanvasRef:r,color:u.value,"pattern-color":n.value},null,8,["color","pattern-color"]))}});export{Ko as B,qo as C,Bo as L,Se as T,ft as _,Do as g,lo as i,dt as r,lt as u};
